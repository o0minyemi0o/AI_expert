# 켤레 사전분포와 지수족

## 왜 켤레 사전분포와 지수족을 배워야 하는가

pt-07에서 베이즈 추론의 핵심이 사후 분포 계산임을 보았습니다. 그런데 일반적으로 사후 분포의 닫힌 형태(closed form)를 구하는 것은 불가능합니다. **켤레 사전분포(conjugate prior)**는 "사전과 사후가 같은 분포족에 속하도록" 설계된 특별한 사전 분포로, 사후 분포를 해석적으로 구할 수 있게 합니다. 이 아름다운 구조의 배후에는 **지수족(exponential family)**이라는 통일적 프레임워크가 있습니다.

이번 강의에서는 켤레 사전분포의 정의와 주요 예시, 그리고 지수족의 일반론을 다룹니다.

---

## 1. 켤레 사전분포의 정의

우도 $p(\mathcal{D}|\theta)$가 특정 분포족에 속할 때, 사전 분포 $p(\theta)$를 적절히 선택하면 사후 분포 $p(\theta|\mathcal{D})$가 사전과 **같은 분포족**에 속하게 됩니다. 이때 $p(\theta)$를 해당 우도에 대한 **켤레 사전분포**라 합니다.

$$
\underbrace{p(\theta)}_{\text{사전: 분포족 } \mathcal{F}} \times \underbrace{p(\mathcal{D}|\theta)}_{\text{우도}} \propto \underbrace{p(\theta|\mathcal{D})}_{\text{사후: 같은 분포족 } \mathcal{F}}
$$

파라미터만 업데이트하면 되므로, 베이즈 추론이 **파라미터 갱신 규칙**으로 단순화됩니다.

> **핵심 직관**: 켤레 사전분포를 사용하면 베이즈 업데이트가 "사전 분포의 파라미터에 데이터 요약량을 더하는 것"으로 귀결됩니다. 마치 사전 분포의 파라미터가 "가상의 관측 데이터"처럼 작용합니다.

---

## 2. 주요 켤레 쌍

| 우도 | 켤레 사전분포 | 사후 분포 | 사후 파라미터 |
|------|-------------|-----------|--------------|
| Bernoulli($\theta$) | Beta($\alpha, \beta$) | Beta($\alpha', \beta'$) | $\alpha' = \alpha + k$, $\beta' = \beta + n - k$ |
| Binomial($n, \theta$) | Beta($\alpha, \beta$) | Beta($\alpha', \beta'$) | 동일 |
| Poisson($\lambda$) | Gamma($\alpha, \beta$) | Gamma($\alpha', \beta'$) | $\alpha' = \alpha + \sum x_i$, $\beta' = \beta + n$ |
| Gaussian($\mu$, 알려진 $\sigma^2$) | Gaussian($\mu_0, \sigma_0^2$) | Gaussian($\mu_n, \sigma_n^2$) | 아래 참조 |
| Gaussian(알려진 $\mu$, $\sigma^2$) | Inv-Gamma($\alpha, \beta$) | Inv-Gamma($\alpha', \beta'$) | $\alpha' = \alpha + n/2$ |
| Categorical($\boldsymbol{\pi}$) | Dirichlet($\boldsymbol{\alpha}$) | Dirichlet($\boldsymbol{\alpha}'$) | $\alpha_k' = \alpha_k + n_k$ |

### 가우시안 평균의 베이즈 업데이트

사전: $\mu \sim \mathcal{N}(\mu_0, \sigma_0^2)$, 우도: $x_i \sim \mathcal{N}(\mu, \sigma^2)$ (알려진 $\sigma^2$)

$$
\mu_n = \frac{\sigma^2\mu_0 + n\sigma_0^2\bar{x}}{\sigma^2 + n\sigma_0^2}, \quad \sigma_n^2 = \frac{\sigma^2\sigma_0^2}{\sigma^2 + n\sigma_0^2}
$$

> **핵심 직관**: 사후 평균 $\mu_n$은 사전 평균 $\mu_0$과 표본 평균 $\bar{x}$의 **정밀도 가중 평균**입니다. 데이터가 많아질수록($n \to \infty$) 사전의 영향은 사라지고 $\mu_n \to \bar{x}$가 됩니다.

---

## 3. 지수족의 정의

**지수족(exponential family)**은 다음 형태의 분포족입니다:

$$
p(x|\boldsymbol{\eta}) = h(x) \exp\!\left(\boldsymbol{\eta}^T \mathbf{T}(x) - A(\boldsymbol{\eta})\right)
$$

각 요소의 의미:

| 기호 | 이름 | 역할 |
|------|------|------|
| $\boldsymbol{\eta}$ | 자연 파라미터 (natural parameter) | 분포를 특정하는 파라미터 |
| $\mathbf{T}(x)$ | 충분 통계량 (sufficient statistic) | 데이터 요약 |
| $A(\boldsymbol{\eta})$ | 로그 분할 함수 (log partition function) | 정규화 상수의 로그 |
| $h(x)$ | 기저 측도 (base measure) | $\boldsymbol{\eta}$에 독립 |

---

## 4. 지수족의 주요 예시

### 4.1 Bernoulli

$p(x|\theta) = \theta^x(1-\theta)^{1-x} = \exp\!\left(x \log\frac{\theta}{1-\theta} + \log(1-\theta)\right)$

- $\eta = \log\frac{\theta}{1-\theta}$ (로짓!), $T(x) = x$, $A(\eta) = \log(1 + e^\eta)$

### 4.2 Gaussian (알려진 분산)

$p(x|\mu) = \frac{1}{\sqrt{2\pi\sigma^2}}\exp\!\left(-\frac{(x-\mu)^2}{2\sigma^2}\right)$

- $\eta = \mu/\sigma^2$, $T(x) = x$, $A(\eta) = \eta^2\sigma^2/2$

### 4.3 Poisson

$p(x|\lambda) = \frac{\lambda^x e^{-\lambda}}{x!} = \frac{1}{x!}\exp(x\log\lambda - \lambda)$

- $\eta = \log\lambda$, $T(x) = x$, $A(\eta) = e^\eta$

> **핵심 직관**: 지수족에서 자연 파라미터 $\eta$는 ML에서 활성화 함수의 역함수로 나타납니다. Bernoulli의 자연 파라미터가 로짓(logit)이므로, 로지스틱 회귀에서 시그모이드를 쓰는 것은 수학적 필연입니다.

---

## 5. 로그 분할 함수의 마법

$A(\boldsymbol{\eta})$를 미분하면 충분 통계량의 기댓값과 분산이 나옵니다:

$$
\frac{\partial A}{\partial \eta_i} = \mathbb{E}[T_i(X)], \quad \frac{\partial^2 A}{\partial \eta_i \partial \eta_j} = \text{Cov}(T_i(X), T_j(X))
$$

따라서 $A(\boldsymbol{\eta})$는 볼록 함수입니다 (Hessian이 공분산 행렬 = 양의 반정치). 이 성질은 co-08에서 다뤘던 볼록 최적화와 직결됩니다.

---

## 6. 지수족과 켤레 사전분포의 연결

지수족 우도에 대한 일반적인 켤레 사전분포는:

$$
p(\boldsymbol{\eta} | \boldsymbol{\chi}, \nu) \propto \exp\!\left(\boldsymbol{\eta}^T \boldsymbol{\chi} - \nu A(\boldsymbol{\eta})\right)
$$

여기서 $\boldsymbol{\chi}$는 "가상 충분 통계량의 합", $\nu$는 "가상 표본 크기"로 해석됩니다.

$n$개의 데이터 관측 후 사후 분포:

$$
p(\boldsymbol{\eta} | \mathcal{D}) \propto \exp\!\left(\boldsymbol{\eta}^T \left(\boldsymbol{\chi} + \sum_{i=1}^n \mathbf{T}(x_i)\right) - (\nu + n) A(\boldsymbol{\eta})\right)
$$

업데이트 규칙: $\boldsymbol{\chi}' = \boldsymbol{\chi} + \sum \mathbf{T}(x_i)$, $\nu' = \nu + n$

---

## 7. Python으로 확인하기

```python
import numpy as np
from scipy import stats

# --- Beta-Bernoulli 켤레 쌍 ---
alpha_prior, beta_prior = 2, 5  # 사전: Beta(2, 5)
data = np.array([1, 1, 0, 1, 1, 0, 1, 0, 1, 1])  # 관측

k = data.sum()
n = len(data)
alpha_post = alpha_prior + k
beta_post = beta_prior + (n - k)

prior = stats.beta(alpha_prior, beta_prior)
posterior = stats.beta(alpha_post, beta_post)

print(f"사전: Beta({alpha_prior}, {beta_prior}), 평균 = {prior.mean():.4f}")
print(f"사후: Beta({alpha_post}, {beta_post}), 평균 = {posterior.mean():.4f}")
print(f"MLE: {k/n:.4f}")

# --- Gaussian 평균의 베이즈 업데이트 ---
mu_0, sigma_0_sq = 0.0, 10.0   # 사전: N(0, 10)
sigma_sq = 1.0                   # 알려진 관측 분산
data_gauss = np.random.normal(3.0, np.sqrt(sigma_sq), size=50)

x_bar = data_gauss.mean()
n_gauss = len(data_gauss)
sigma_n_sq = 1 / (1/sigma_0_sq + n_gauss/sigma_sq)
mu_n = sigma_n_sq * (mu_0/sigma_0_sq + n_gauss*x_bar/sigma_sq)

print(f"\n사전 평균: {mu_0:.4f}")
print(f"표본 평균: {x_bar:.4f}")
print(f"사후 평균: {mu_n:.4f}")
print(f"사후 분산: {sigma_n_sq:.6f}")

# --- 지수족: Bernoulli의 자연 파라미터 ---
theta = 0.7
eta = np.log(theta / (1 - theta))  # 로짓
A_eta = np.log(1 + np.exp(eta))     # 로그 분할 함수

# A'(η) = E[T(X)] = θ
import scipy.misc
A_prime = scipy.misc.derivative(lambda e: np.log(1 + np.exp(e)), eta, dx=1e-8)
print(f"\nA'(η) = {A_prime:.4f}, θ = {theta:.4f}")  # 일치해야 함
```

---

## 핵심 정리

1. **켤레 사전분포**는 사후 분포가 사전과 같은 분포족에 속하게 하여, 베이즈 업데이트를 **파라미터 갱신**으로 단순화한다.
2. **지수족**은 $p(x|\boldsymbol{\eta}) = h(x)\exp(\boldsymbol{\eta}^T\mathbf{T}(x) - A(\boldsymbol{\eta}))$ 형태의 분포족으로, Bernoulli·Gaussian·Poisson 등 대부분의 표준 분포를 포함한다.
3. **로그 분할 함수** $A(\boldsymbol{\eta})$의 미분은 충분 통계량의 모멘트를 생성하며, 항상 **볼록 함수**이다.
4. 지수족의 자연 파라미터는 ML의 **링크 함수(link function)**와 직접 연결된다 — Bernoulli의 자연 파라미터가 로짓이다.
5. 모든 지수족 우도에 대해 **일반적인 켤레 사전분포**가 존재하며, 업데이트는 가상 데이터($\boldsymbol{\chi}, \nu$)에 실제 데이터를 더하는 것이다.
