# 실험 설계의 기초

## 왜 실험 설계를 배워야 하는가

인과 관계를 확립하는 가장 강력한 도구는 잘 설계된 실험입니다. 관찰 데이터만으로는 교란 변수를 완벽히 통제할 수 없으며, ci-05에서 배운 잠재 결과 프레임워크가 보여주듯 반사실(counterfactual)은 직접 관측할 수 없습니다. 실험 설계는 무작위 배정이라는 단순하지만 강력한 원리를 통해 이 문제를 해결합니다.

---

## 1. 실험의 기본 구성 요소

모든 실험은 세 가지 핵심 요소로 구성됩니다.

| 구성 요소 | 정의 | 예시 |
|-----------|------|------|
| **처치(Treatment)** | 실험 대상에게 적용하는 개입 | 새로운 버튼 색상, 약물 투여량 |
| **통제 집단(Control)** | 기존 상태를 유지하는 비교 그룹 | 기존 버튼 색상, 위약 투여 |
| **결과 변수(Outcome)** | 처치 효과를 측정하는 지표 | 클릭률, 혈압 변화 |

> **핵심 직관**: 처치 집단과 통제 집단의 유일한 차이가 처치 자체일 때, 결과의 차이는 곧 인과 효과입니다.

실험 단위(experimental unit)는 처치가 배정되는 최소 단위입니다. 넷플릭스 추천 실험에서 실험 단위는 개별 사용자이며, 학교 교육 프로그램 실험에서는 학급 또는 학교가 될 수 있습니다.

---

## 2. 무작위 배정의 원리

무작위 배정(randomization)은 실험 설계의 핵심입니다. 각 실험 단위가 처치 집단에 배정될 확률이 동일하도록 보장합니다.

$$P(Z_i = 1) = p, \quad \forall i \in \{1, 2, \ldots, N\}$$

여기서 $Z_i$는 단위 $i$의 처치 배정 지시 변수이고, $p$는 배정 확률입니다.

무작위 배정이 보장하는 것은 **관측된 변수와 관측되지 않은 변수 모두에서** 집단 간 균형입니다.

```python
import numpy as np

# 단순 무작위 배정
np.random.seed(42)
n_users = 10000
assignment = np.random.binomial(1, 0.5, size=n_users)

print(f"처치 집단: {assignment.sum()}, 통제 집단: {n_users - assignment.sum()}")
# 처치 집단: 5017, 통제 집단: 4983
```

> **핵심 직관**: 무작위 배정은 '운'에 의존하는 것이 아니라, 대수의 법칙에 의해 체계적 편향을 제거하는 수학적 장치입니다.

---

## 3. 편향의 원천

실험에서 발생할 수 있는 주요 편향을 이해해야 올바른 인과 추론이 가능합니다.

| 편향 유형 | 설명 | 예시 |
|-----------|------|------|
| **선택 편향(Selection Bias)** | 처치 배정이 결과와 상관된 변수에 의존 | 자발적 참여자만 실험에 포함 |
| **이탈 편향(Attrition Bias)** | 처치/통제 간 이탈률 차이 | 부작용으로 처치 집단 이탈률 증가 |
| **노벨티 효과(Novelty Effect)** | 새로움 자체가 단기 효과를 생성 | 새 UI 출시 직후의 일시적 참여 증가 |
| **호손 효과(Hawthorne Effect)** | 관찰받는다는 인식이 행동 변화 유발 | 실험 참여 인지 시 행동 변화 |

버튼 색상 A/B 테스트에서 노벨티 효과를 무시하면, 초기 클릭률 상승을 영구적 효과로 오인할 수 있습니다.

```python
import numpy as np

# 노벨티 효과 시뮬레이션
days = np.arange(1, 31)
true_effect = 0.02  # 진짜 효과: 2%
novelty_decay = 0.05 * np.exp(-0.2 * days)  # 지수적 감쇠
observed_effect = true_effect + novelty_decay

print(f"1일차 관측 효과: {observed_effect[0]:.3f}")
print(f"30일차 관측 효과: {observed_effect[-1]:.3f}")
# 1일차: 0.061, 30일차: 0.020 (진짜 효과에 수렴)
```

> **핵심 직관**: 편향은 추정량의 기대값을 참값에서 체계적으로 이탈시키며, 표본 크기를 아무리 늘려도 사라지지 않습니다.

---

## 4. 타당도의 유형

실험의 품질은 네 가지 타당도 차원으로 평가합니다.

| 타당도 유형 | 질문 | 위협 요인 |
|-------------|------|-----------|
| **내적 타당도** | 인과 관계가 올바른가? | 교란 변수, 선택 편향 |
| **외적 타당도** | 다른 모집단에도 일반화되는가? | 표본의 대표성 부족 |
| **구성 타당도** | 측정이 개념을 정확히 반영하는가? | 지표 정의 오류 |
| **통계적 결론 타당도** | 통계 분석이 올바른가? | 낮은 검정력, 다중 비교 |

$$\text{내적 타당도} \xrightarrow{\text{전제}} \text{외적 타당도}$$

내적 타당도가 확보되지 않으면 외적 타당도를 논하는 것 자체가 무의미합니다. si-05에서 다룬 가설 검정의 오류 유형과 통계적 결론 타당도는 밀접하게 연결됩니다.

> **핵심 직관**: 내적 타당도는 "이 실험 안에서" 인과 관계가 성립하는지, 외적 타당도는 "이 실험 밖에서도" 성립하는지를 묻습니다.

---

## 5. 실험 설계의 기본 유형

| 설계 유형 | 특징 | 적합한 상황 |
|-----------|------|-------------|
| **완전 무작위 설계** | 모든 단위를 무작위 배정 | 동질적 실험 단위 |
| **블록 설계** | 블록 내 무작위 배정 | 이질적 집단(국가, 플랫폼별) |
| **교차 설계(Crossover)** | 각 단위가 순서대로 두 처치 경험 | 이월 효과가 없는 경우 |
| **팩토리얼 설계** | 여러 요인을 동시에 검증 | 상호작용 효과 탐색 (ed-05 참조) |

```python
import numpy as np

# 블록 무작위 배정: 모바일/데스크탑 사용자를 별도 블록으로
np.random.seed(42)
mobile_users = np.arange(1, 5001)
desktop_users = np.arange(5001, 10001)

mobile_treat = np.random.choice(mobile_users, size=2500, replace=False)
desktop_treat = np.random.choice(desktop_users, size=2500, replace=False)

print(f"모바일 처치 집단: {len(mobile_treat)}명")
print(f"데스크탑 처치 집단: {len(desktop_treat)}명")
```

> **핵심 직관**: 블록 설계는 알려진 이질성을 사전에 통제하여 추정의 정밀도를 높이는 전략입니다. ed-03에서 다루는 분산 감소 기법과 직접 연결됩니다.

---

## 6. 인과 효과의 정의와 추정

잠재 결과 프레임워크에서 단위 $i$의 개별 처치 효과(ITE)는 다음과 같습니다.

$$\tau_i = Y_i(1) - Y_i(0)$$

그러나 근본적 인과 추론 문제(Fundamental Problem of Causal Inference)로 인해 $Y_i(1)$과 $Y_i(0)$을 동시에 관측할 수 없습니다. 따라서 우리는 **평균 처치 효과(ATE)**를 추정합니다.

$$\text{ATE} = E[Y_i(1) - Y_i(0)] = E[Y_i(1)] - E[Y_i(0)]$$

무작위 배정 하에서 ATE의 비편향 추정량은 단순 평균 차이입니다.

$$\hat{\tau} = \bar{Y}_{\text{treat}} - \bar{Y}_{\text{control}}$$

```python
import numpy as np
from scipy import stats

# ATE 추정 시뮬레이션
np.random.seed(42)
n = 5000
y_control = np.random.normal(10, 3, n)
y_treat = np.random.normal(10.5, 3, n)  # 진짜 효과: 0.5

ate_hat = y_treat.mean() - y_control.mean()
se = np.sqrt(y_treat.var()/n + y_control.var()/n)
ci_lower, ci_upper = ate_hat - 1.96*se, ate_hat + 1.96*se

print(f"ATE 추정값: {ate_hat:.3f}")
print(f"95% 신뢰구간: [{ci_lower:.3f}, {ci_upper:.3f}]")
```

> **핵심 직관**: 무작위 배정은 $E[Y(0) \mid Z=1] = E[Y(0) \mid Z=0]$을 보장하여, 관측된 평균 차이를 인과 효과로 해석할 수 있게 합니다.

---

## 7. 실험 윤리와 실무 고려사항

실험 설계에서 윤리적 고려는 선택이 아닌 필수입니다.

| 원칙 | 설명 | 실무 적용 |
|------|------|-----------|
| **동의(Consent)** | 참여자에게 실험 사실 고지 | 서비스 약관에 실험 가능성 명시 |
| **최소 위해** | 참여자에게 해를 끼치지 않음 | 극단적 처치 배제 |
| **형평성** | 특정 집단에 불이익 금지 | 취약 계층 보호 조치 |
| **데이터 보호** | 개인정보 보호 | 익명화, 최소 수집 원칙 |

넷플릭스 추천 실험에서 의도적으로 나쁜 추천을 제공하는 것은 사용자 경험을 해치므로 윤리적으로 문제가 됩니다. 실제로 많은 기업은 실험 검토 위원회(Experiment Review Board)를 운영합니다.

> **핵심 직관**: 좋은 실험 설계는 과학적 엄밀성과 윤리적 책임 사이의 균형을 찾는 과정입니다.

---

## 핵심 정리

- **무작위 배정은 관측/비관측 교란 변수 모두를 균형시켜 인과 추론의 기반을 제공합니다**
- **선택 편향, 이탈 편향, 노벨티 효과 등 다양한 편향이 실험 결과를 왜곡할 수 있습니다**
- **내적 타당도(인과 관계의 정확성)가 외적 타당도(일반화 가능성)의 전제 조건입니다**
- **블록 설계와 팩토리얼 설계는 실험의 정밀도와 효율성을 높이는 기본 전략입니다**
- **평균 처치 효과(ATE)는 잠재 결과의 기대값 차이로 정의되며, 무작위 배정 하에서 비편향 추정이 가능합니다**
