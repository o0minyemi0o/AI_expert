# 광고 시스템 설계

## 왜 광고 시스템 설계가 중요한가

광고 시스템은 구글, 메타, 아마존 등 대형 테크 기업의 **핵심 수익원**이며, ML이 가장 큰 비즈니스 임팩트를 만드는 영역입니다. CTR 예측 모델의 정확도가 0.1% 개선되면 연간 수억 달러의 추가 매출이 발생합니다. 면접에서도 추천 시스템(sd-02)과 함께 가장 빈출되는 주제입니다.

> **핵심 직관**: 광고 시스템은 "광고주, 사용자, 플랫폼" 세 이해관계자의 균형을 최적화하는 문제입니다. 한쪽에만 치우치면 시스템이 붕괴합니다.

## 1. 광고 시스템 아키텍처

```
광고 서빙 파이프라인:

  [광고 요청 (페이지 로드)]
       │
       ▼
  [광고 후보 선택 Ad Retrieval]
  ├─ 타겟팅 조건 필터링 (지역, 연령 등)
  └─ 예산 필터링 (일 예산 소진 여부)
       │
       ▼ (수천 개 후보)
  [CTR/CVR 예측]
  └─ 각 광고의 클릭/전환 확률 예측
       │
       ▼
  [경매 Auction]
  └─ eCPM = bid × pCTR × pCVR
     → 최고 eCPM 순으로 정렬
       │
       ▼
  [광고 품질 & 정책 필터링]
  ├─ 광고 품질 점수
  └─ 정책 위반 여부
       │
       ▼
  [광고 노출]
```

## 2. CTR 예측 모델

CTR(Click-Through Rate) 예측은 광고 시스템의 핵심 ML 컴포넌트입니다.

| 모델 세대 | 모델 | 특징 |
|----------|------|------|
| 1세대 | Logistic Regression | 해석 가능, 빠름, 수동 피처 |
| 2세대 | GBDT (XGBoost) | 자동 비선형, 피처 중요도 |
| 3세대 | Wide & Deep | 기억(Wide) + 일반화(Deep) |
| 4세대 | DeepFM, DCN | 자동 교차 피처, End-to-end |
| 5세대 | DLRM, DIN | 대규모 임베딩, 시퀀스 모델링 |

```
DeepFM 구조:

  입력 피처: [유저ID, 광고ID, 시간대, 디바이스, ...]
       │
       ├──→ [FM Layer]        : 2차 교차 피처 (선형 복잡도)
       │     └─ Σ <vᵢ, vⱼ> xᵢxⱼ
       │
       ├──→ [Deep Layer]      : 고차 비선형 패턴
       │     └─ DNN (여러 층)
       │
       └──→ [Linear Layer]    : 1차 피처
              └─ wᵀx + b

  출력: sigmoid(FM + Deep + Linear) = pCTR
```

> **핵심 직관**: CTR 예측에서 **피처 교차**(feature cross)가 핵심입니다. "20대 여성 × 화장품 광고 × 저녁 시간"처럼 여러 피처의 조합이 클릭 확률을 결정합니다. DeepFM은 이를 자동으로 학습합니다.

## 3. 피처 엔지니어링

광고 CTR 예측에서 피처 설계가 모델 성능의 70% 이상을 결정합니다.

```
광고 피처 카테고리:

  유저 피처                광고 피처              컨텍스트 피처
  ──────────             ──────────            ──────────
  - 인구통계              - 광고 크리에이티브       - 시간대
  - 관심사 세그먼트        - 광고주 품질           - 디바이스
  - 과거 클릭 이력         - 랜딩 페이지 품질      - 페이지 위치
  - 최근 검색 쿼리         - 광고 노출 빈도        - 인접 콘텐츠

  실시간 피처 (sd-09 파이프라인)
  ──────────────────────────────
  - 세션 내 광고 클릭 수
  - 최근 10분 내 전환 이벤트
  - 현재 페이지 체류 시간
```

| 피처 유형 | 갱신 주기 | 저장소 | 지연시간 |
|----------|----------|--------|---------|
| 정적 피처 | 일 1회 | 배치 피처 스토어 | < 1ms |
| 준실시간 | 분 단위 | 스트리밍 피처 | < 10ms |
| 실시간 | 요청마다 | 인메모리 계산 | < 5ms |

## 4. 경매 메커니즘

```
경매 방식 비교:

  1차 가격 경매 (First-Price):
  └─ 낙찰자가 자신의 입찰가를 지불
     장점: 단순  |  단점: 입찰 전략 게임

  2차 가격 경매 (Second-Price / VCG):
  └─ 낙찰자가 2등의 입찰가 + 1원을 지불
     장점: 진실 보고 유도  |  단점: 매출 예측 어려움

  eCPM 기반 경매 (실제 사용):
  └─ eCPM = bid × pCTR (× pCVR)
     → 클릭당 비용(CPC)이 아닌 노출당 기대 수익으로 비교
```

```python
# 광고 경매 시뮬레이션 — eCPM 기반
def run_auction(ads: list[dict], user_context: dict) -> dict:
    """각 광고의 eCPM을 계산하여 낙찰자 결정"""
    scored_ads = []
    for ad in ads:
        pctr = predict_ctr(ad, user_context)      # CTR 예측
        pcvr = predict_cvr(ad, user_context)       # CVR 예측
        ecpm = ad["bid"] * pctr * pcvr * 1000      # eCPM 계산
        quality_score = ad_quality_model(ad)        # 품질 점수

        # 최종 점수 = eCPM × 품질 (저품질 광고 페널티)
        final_score = ecpm * quality_score
        scored_ads.append((ad, final_score, pctr))

    # 점수 내림차순 정렬
    scored_ads.sort(key=lambda x: x[1], reverse=True)
    winner = scored_ads[0]

    # 2차 가격: 2등의 점수로 실제 과금액 결정
    runner_up_score = scored_ads[1][1] if len(scored_ads) > 1 else 0
    actual_cost = runner_up_score / (winner[2] * 1000)  # CPC로 변환

    return {"ad": winner[0], "cost_per_click": actual_cost}
```

## 5. 예산 최적화와 페이싱

광고주의 일일/월간 예산을 효율적으로 분배하는 전략입니다.

| 전략 | 설명 | 적합한 상황 |
|------|------|-----------|
| Uniform Pacing | 시간대별 균등 분배 | 기본 전략 |
| Front-loading | 초반 집중 소진 | 시간 한정 프로모션 |
| Throttling | 경쟁 낮은 시간대에 집중 | ROI 최적화 |
| PID Controller | 피드백 기반 동적 조절 | 정밀 예산 관리 |

```
예산 페이싱 개념:

  예산 소진율
  100%│         ╱── Ideal (균등)
     │        ╱
     │     ╱╱  ── Actual (조절 중)
  50%│   ╱╱
     │  ╱
     │╱───── Over-spending (위험!)
   0%└──────────────────────
     00:00    12:00    24:00
```

> **핵심 직관**: 예산 페이싱은 "좋은 기회에 입찰하면서도 예산을 하루 종일 유지하는" 최적화 문제입니다. co-08에서 다룬 라그랑주 승수법이 이론적 기초가 됩니다.

## 6. 광고 품질과 사용자 경험

```
광고 품질 시스템:

  광고 품질 점수 = f(관련도, 랜딩 페이지 품질, 과거 CTR)

  품질 낮은 광고 처리:
  ├─ 최소 품질 기준 미달 → 경매 제외
  ├─ 품질 점수로 eCPM 보정 → 자연스러운 페널티
  └─ 사용자 피드백 (숨김, 신고) → 품질 점수 하락

  광고 빈도 제어:
  ├─ Frequency Capping: 사용자당 일일 최대 노출 수 제한
  └─ 다양성: 동일 광고주 연속 노출 방지
```

광고 시스템은 sd-02(추천)의 파이프라인 구조를 공유하지만, 경매와 예산이라는 고유한 비즈니스 로직이 추가됩니다. sd-10에서 다룰 모델 서빙의 지연시간 제약이 특히 엄격한 영역이기도 합니다.

## 핵심 정리

- 광고 시스템은 **광고주(ROI), 사용자(경험), 플랫폼(매출)** 세 이해관계자의 균형을 최적화합니다
- CTR 예측 모델은 Logistic Regression에서 **DeepFM/DLRM으로 진화**했으며, 피처 교차가 핵심입니다
- 경매는 **eCPM(bid × pCTR × pCVR) 기반**으로 수행되며, 2차 가격 경매가 진실 보고를 유도합니다
- **예산 페이싱**은 광고주의 예산을 하루에 걸쳐 효율적으로 분배하는 최적화 문제입니다
- 광고 **품질 점수와 빈도 제어**로 사용자 경험을 보호하면서 장기적 생태계 건강을 유지합니다
