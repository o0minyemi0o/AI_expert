# 사기 탐지 시스템

## 왜 사기 탐지 시스템이 중요한가

금융, 이커머스, 결제 플랫폼에서 사기(fraud)는 연간 수십조 원의 손실을 발생시킵니다. 사기 탐지 시스템은 **극단적 클래스 불균형**(정상 99.9% vs 사기 0.1%), **실시간 판단**, **끊임없이 진화하는 공격 패턴**이라는 독특한 도전을 가진 ML 시스템입니다. pt-03에서 다룬 베이즈 정리가 왜 불균형 데이터에서 중요한지 여기서 체감하게 됩니다.

> **핵심 직관**: 사기 탐지의 핵심 어려움은 "정밀도와 재현율의 극단적 트레이드오프"입니다. 정상 거래를 사기로 잘못 판단하면(오탐) 고객이 이탈하고, 사기를 놓치면(미탐) 직접적 금전 손실이 발생합니다.

## 1. 사기 탐지 시스템 아키텍처

```
사기 탐지 파이프라인:

  [거래 이벤트]
       │
       ▼
  [실시간 피처 계산]
  ├─ 속도 피처 (최근 1시간 거래 횟수)
  ├─ 디바이스/위치 피처
  └─ 행동 패턴 피처
       │
       ▼
  [규칙 엔진 Layer 1]
  ├─ 블랙리스트 매칭 → 즉시 차단
  ├─ 금액 임계값 초과 → 검토 대상
  └─ 통과 → ML 모델로 전달
       │
       ▼
  [ML 모델 Layer 2]
  └─ 사기 확률 예측 (0~1)
       │
       ├─ P > 0.9  → 자동 차단
       ├─ P > 0.5  → 수동 검토 큐
       └─ P < 0.5  → 승인
       │
       ▼
  [피드백 루프]
  └─ 검토 결과, 차지백 데이터 → 모델 재학습
```

## 2. 클래스 불균형 처리

사기 데이터는 전체의 0.01-0.1%에 불과합니다. cm-01에서 다룬 분류 기법에 불균형 처리를 추가합니다.

| 기법 | 설명 | 장단점 |
|------|------|--------|
| Undersampling | 정상 데이터 줄이기 | 간단, 정보 손실 |
| Oversampling | 사기 데이터 복제 | 과적합 위험 |
| SMOTE | 합성 사기 데이터 생성 | 노이즈 생성 가능 |
| Focal Loss | 어려운 샘플에 가중치 | 하이퍼파라미터 민감 |
| 비용 민감 학습 | 클래스별 비용 부여 | 비즈니스 비용 반영 가능 |

```python
# 비용 민감 학습: 사기 미탐의 비용이 오탐보다 훨씬 크다
# 사기 1건 미탐 = 평균 $500 손실
# 정상 1건 오탐 = 고객 불편 + 검토 비용 $5

import numpy as np
from sklearn.ensemble import GradientBoostingClassifier

# 비용 비율로 sample_weight 설정
sample_weights = np.where(y_train == 1, 100, 1)  # 사기:정상 = 100:1

model = GradientBoostingClassifier()
model.fit(X_train, y_train, sample_weight=sample_weights)

# 임계값도 비용에 맞게 조정 (기본 0.5가 아닌)
probs = model.predict_proba(X_test)[:, 1]
threshold = 0.3  # 재현율 높이기 위해 낮은 임계값
predictions = (probs >= threshold).astype(int)
```

> **핵심 직관**: 불균형 데이터에서 정확도(accuracy)는 의미 없습니다. 모든 거래를 "정상"으로 예측해도 99.9% 정확도가 나옵니다. **Precision-Recall 곡선**과 **비용 기반 평가**가 올바른 메트릭입니다.

## 3. 규칙 + ML 하이브리드 시스템

실무에서는 규칙 기반과 ML 기반을 **계층적으로 결합**합니다.

```
하이브리드 시스템의 역할 분담:

  규칙 엔진 (결정론적)           ML 모델 (확률적)
  ──────────────────          ──────────────────
  장점:                        장점:
  - 즉시 적용 가능              - 복잡한 패턴 포착
  - 설명 가능                  - 새로운 패턴 학습
  - 규제 요구사항 충족           - 대규모 피처 활용
  - 제로데이 대응 (신규 규칙)

  단점:                        단점:
  - 복잡한 패턴 못 잡음          - 블랙박스
  - 유지보수 비용 증가           - 학습 데이터 필요
  - 우회 공격에 취약             - 레이블 지연

  실무 접근: 규칙 = 1차 방어선, ML = 2차 정밀 탐지
```

## 4. 피처 엔지니어링

사기 탐지의 피처 설계는 **시간 윈도우 기반 집계**가 핵심입니다.

```
사기 탐지 핵심 피처:

  [속도 피처 Velocity Features]
  - 최근 1시간 내 거래 횟수
  - 최근 24시간 내 고유 IP 수
  - 최근 7일 내 새 수령인 수

  [편차 피처 Deviation Features]
  - 평소 평균 거래 금액 대비 편차
  - 평소 거래 시간대 대비 편차
  - 평소 거래 위치 대비 거리

  [그래프 피처 Graph Features]
  - 동일 디바이스를 공유하는 계정 수
  - 동일 수령인에게 보내는 계정 수
  - 네트워크 내 사기 계정 비율

  [세션 피처 Session Features]
  - 로그인-거래 간 시간 (짧으면 의심)
  - 페이지 이동 패턴 (비정상 경로)
  - 마우스/키보드 행동 패턴
```

| 피처 그룹 | 탐지 대상 | 계산 위치 |
|----------|----------|----------|
| 속도 피처 | 대량 자동 공격 | 실시간 스트리밍 |
| 편차 피처 | 계정 탈취 | 배치 + 실시간 |
| 그래프 피처 | 조직적 사기 | 배치 (주기적 갱신) |
| 세션 피처 | 봇/자동화 | 실시간 |

## 5. 모델 설명 가능성

금융 규제(GDPR, 금융소비자보호법 등)에 따라 사기 판정의 **이유를 설명**해야 합니다.

```python
# SHAP으로 사기 판정 이유 설명
import shap

explainer = shap.TreeExplainer(model)
shap_values = explainer.shap_values(X_test[fraud_case])

# 결과 예시:
# "이 거래가 사기로 판정된 주요 이유:
#  1. 최근 1시간 내 거래 횟수: 15회 (평소 1-2회) → +0.35
#  2. 거래 금액: $2,500 (평소 $50-100) → +0.28
#  3. 새로운 디바이스에서 접속 → +0.15
#  4. 해외 IP 주소 → +0.12"
```

> **핵심 직관**: 설명 가능성은 규제 준수만의 문제가 아닙니다. 수동 검토자가 SHAP 결과를 보고 빠르게 판단할 수 있어야 **검토 효율성**이 올라갑니다.

## 6. 피드백 루프와 레이블 지연

```
레이블 획득의 현실:

  거래 발생 ─────→ 사기 판정 ─────→ 차지백 접수
  (즉시)          (밀리초)          (30-90일 후!)

  문제: 모델 학습에 사용할 "정답"이 수개월 후에야 확정됨

  해결 전략:
  ├─ 단기 피드백: 고객 신고 (수일 내) → 즉시 학습
  ├─ 중기 피드백: 차지백 (30-90일) → 주기적 재학습
  ├─ 준지도 학습: 레이블 없는 데이터도 패턴 학습
  └─ 적대적 검증: 의도적으로 일부 의심 거래 통과시켜 레이블 수집
```

사기 탐지 시스템은 sd-09에서 다룰 실시간 데이터 파이프라인과 깊이 연관되며, sd-01의 설계 프레임워크를 불균형 데이터라는 특수 상황에 적용한 사례입니다.

## 핵심 정리

- 사기 탐지는 **규칙 엔진(1차 방어) + ML 모델(2차 정밀)**의 하이브리드 구조가 실무 표준입니다
- 극단적 클래스 불균형(0.1% 사기)에서 **정확도는 무의미**하며, Precision-Recall과 비용 기반 평가가 적합합니다
- **속도 피처**(시간 윈도우 집계)와 **그래프 피처**(계정 간 관계)가 사기 패턴을 포착하는 핵심입니다
- 금융 규제에 따라 SHAP/LIME 등으로 **판정 이유를 설명**할 수 있어야 합니다
- **레이블 지연**(30-90일)은 사기 탐지 고유의 도전이며, 단기/중기 피드백을 조합하여 해결합니다
