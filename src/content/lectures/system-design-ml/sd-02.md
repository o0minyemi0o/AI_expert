# 추천 시스템 설계

## 왜 추천 시스템이 중요한가

추천 시스템은 ML 시스템 설계 면접에서 **가장 빈출되는 주제**입니다. 넷플릭스, 유튜브, 아마존 등 대부분의 대형 서비스가 추천에 의존하며, 전체 매출의 30-80%가 추천을 통해 발생합니다. 추천 시스템은 데이터 파이프라인, 피처 엔지니어링, 모델 서빙의 모든 요소를 포함하는 종합적인 ML 시스템입니다.

> **핵심 직관**: 추천 시스템의 핵심 도전은 "수백만 아이템 중에서 수십 개를 수백 밀리초 안에 골라내는 것"입니다. 이 제약이 전체 아키텍처를 결정합니다.

## 1. 추천 시스템 아키텍처 개요

대규모 추천 시스템은 단일 모델이 아니라 **다단계 파이프라인**으로 구성됩니다.

```
추천 파이프라인 아키텍처:

  전체 아이템 (수백만~수억)
       │
       ▼
  [후보 생성 Candidate Generation]
  ├─ 협업 필터링        ─┐
  ├─ 콘텐츠 기반         ├─→ 후보 풀 (수천)
  └─ 인기도 기반        ─┘
       │
       ▼
  [랭킹 Ranking]
  └─ 정밀 모델 (DNN)     ──→ 정렬된 리스트 (수백)
       │
       ▼
  [리랭킹 Re-ranking]
  ├─ 다양성 보장
  ├─ 비즈니스 규칙        ──→ 최종 추천 (수십)
  └─ 필터링 (성인, 저품질)
```

| 단계 | 아이템 수 | 지연시간 예산 | 모델 복잡도 |
|------|----------|-------------|-----------|
| 후보 생성 | 10M → 1K | < 50ms | 경량 |
| 랭킹 | 1K → 100 | < 100ms | 중간~무거움 |
| 리랭킹 | 100 → 20 | < 50ms | 규칙 + 경량 |

## 2. 협업 필터링

la-05에서 다룬 행렬 분해가 추천 시스템의 핵심 기법으로 활용됩니다.

```
사용자-아이템 상호작용 행렬:

         아이템₁  아이템₂  아이템₃  아이템₄
  유저₁ [  5      ?      3      ?  ]
  유저₂ [  ?      4      ?      2  ]     →  행렬 분해  →  U × V^T
  유저₃ [  4      ?      ?      5  ]         (k차원)
  유저₄ [  ?      3      4      ?  ]

  U: 유저 임베딩 (n × k)
  V: 아이템 임베딩 (m × k)
  예측: score(u, i) = U_u · V_i
```

| 방식 | 장점 | 단점 |
|------|------|------|
| User-based CF | 직관적, 설명 가능 | 스케일링 어려움 |
| Item-based CF | 안정적, 계산 효율 | 새 아이템 대응 약함 |
| Matrix Factorization | 잠재 요인 포착 | 콜드 스타트 |
| Neural CF (dl-08) | 비선형 관계 학습 | 학습 비용 높음 |

## 3. 콘텐츠 기반 필터링과 하이브리드

협업 필터링의 콜드 스타트 문제를 해결하기 위해 **콘텐츠 기반 접근**을 결합합니다.

```python
# Two-Tower 모델 구조 (후보 생성용)
# 사용자 타워와 아이템 타워를 독립적으로 인코딩

class TwoTowerModel:
    def __init__(self, embed_dim=64):
        # 유저 타워: 유저 피처 → 임베딩
        self.user_tower = Sequential([
            Dense(128, activation='relu'),  # 유저 프로필, 행동 이력
            Dense(embed_dim)
        ])
        # 아이템 타워: 아이템 피처 → 임베딩
        self.item_tower = Sequential([
            Dense(128, activation='relu'),  # 아이템 메타데이터, 콘텐츠
            Dense(embed_dim)
        ])

    def predict(self, user_features, item_features):
        user_emb = self.user_tower(user_features)
        item_emb = self.item_tower(item_features)
        return dot(user_emb, item_emb)  # 코사인 유사도

# 서빙 시: 아이템 임베딩을 미리 인덱싱 (ANN)
# → 유저 임베딩으로 근접 이웃 검색 → O(log n) 후보 생성
```

> **핵심 직관**: Two-Tower 모델의 핵심 장점은 아이템 임베딩을 **오프라인에서 미리 계산**하고 ANN 인덱스(FAISS, ScaNN)에 저장하여, 실시간 서빙 시 밀리초 단위로 후보를 생성할 수 있다는 것입니다.

## 4. 랭킹 모델

후보 생성 단계를 통과한 수천 개의 아이템을 정밀하게 점수화합니다.

```
랭킹 모델 피처 구성:

  유저 피처                아이템 피처             교차 피처
  ──────────             ──────────            ──────────
  - 나이, 성별             - 카테고리              - 유저×카테고리 이력
  - 과거 시청 이력          - 업로드 시간           - 유저×크리에이터 친밀도
  - 세션 내 행동           - 인기도               - 시간대별 선호도
  - 디바이스              - 길이/품질             - 위치 기반 관련도
```

| 모델 | 특징 | 사용 사례 |
|------|------|----------|
| Logistic Regression | 빠름, 해석 가능 | 베이스라인 |
| GBDT (LightGBM) | 피처 중요도 파악 | 구조화 데이터 |
| Wide & Deep | 기억 + 일반화 | 구글 추천 |
| DeepFM | 자동 교차 피처 | 피처 교차 중요 시 |
| DIN (Deep Interest) | 유저 행동 시퀀스 | 개인화 중시 |

## 5. 콜드 스타트 문제

새로운 사용자나 아이템에 대한 데이터가 없는 상황을 처리해야 합니다.

| 콜드 스타트 유형 | 해결 전략 |
|---------------|----------|
| 새 사용자 | 인기도 기반 추천, 온보딩 설문, 콘텐츠 기반 |
| 새 아이템 | 콘텐츠 피처 활용, 소수 사용자 탐색 노출, 밴딧 알고리즘 |
| 새 도메인 | 전이 학습, 크로스 도메인 임베딩 |

```
콜드 스타트 전략 결정:

  새 사용자 유입
    │
    ├─ 프로필 정보 있음? → 콘텐츠 기반 + 인구통계 기반
    │
    ├─ 3개 이상 상호작용? → 협업 필터링 시작
    │
    └─ 상호작용 없음? → 인기도 기반 + Epsilon-Greedy 탐색
```

## 6. 실시간 피처와 모니터링

```
실시간 피처 파이프라인:

  [유저 행동] → [이벤트 스트림(Kafka)] → [실시간 피처 계산]
                                              │
                                              ▼
                                       [피처 스토어]
                                              │
                                              ▼
                                       [랭킹 모델 추론]

  실시간 피처 예시:
  - 최근 30분 내 클릭한 카테고리 분포
  - 세션 내 시청 시간 누적
  - 최근 좋아요/싫어요 비율
```

> **핵심 직관**: 실시간 피처는 추천 품질을 크게 높이지만, 파이프라인 복잡도와 비용이 증가합니다. sd-01에서 다룬 트레이드오프 분석을 적용하여, 가장 임팩트가 큰 피처부터 실시간화하는 전략이 필요합니다.

## 핵심 정리

- 대규모 추천 시스템은 **후보 생성 → 랭킹 → 리랭킹** 다단계 파이프라인으로 구성되며, 각 단계의 지연시간 예산이 다릅니다
- **협업 필터링**(행렬 분해)과 **콘텐츠 기반 필터링**을 결합한 하이브리드 접근이 실무 표준입니다
- Two-Tower 모델은 아이템 임베딩을 **ANN 인덱스에 오프라인 저장**하여 밀리초 단위 후보 생성을 가능하게 합니다
- **콜드 스타트** 문제는 인기도 기반, 콘텐츠 기반, 밴딧 알고리즘을 상황에 맞게 조합하여 해결합니다
- 실시간 피처는 추천 품질을 높이지만, **비용 대비 임팩트**를 분석하여 우선순위를 정해야 합니다
