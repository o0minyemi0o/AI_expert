# 데이터 모델링

## 왜 데이터 모델링이 중요한가

아무리 좋은 파이프라인을 구축해도, **최종 데이터가 분석하기 어려운 구조**면 의미가 없습니다. 데이터 모델링은 원천 데이터를 분석에 최적화된 구조로 설계하는 과정입니다. dp-01의 ELT에서 "T(Transform)"의 목적지가 바로 이 데이터 모델이며, sql-09의 분석 쿼리가 빠르게 동작하는 이유가 올바른 모델링에 있습니다.

> **핵심 직관**: OLTP DB의 정규화는 "쓰기를 위한 최적화"이고, 분석 DW의 차원 모델링은 "읽기를 위한 최적화"입니다. 목적이 다르므로 구조도 달라야 합니다.

## 1. 정규화 vs 비정규화

```
정규화 (OLTP):

  orders: [order_id, customer_id, product_id, quantity]
  customers: [customer_id, name, city_id]
  cities: [city_id, city_name, country_id]
  countries: [country_id, country_name]

  → 중복 없음, UPDATE 안전
  → 분석 시 4개 테이블 JOIN 필요

비정규화 (OLAP/DW):

  fact_orders: [order_id, customer_name, city_name,
                country_name, product_name, quantity, amount]

  → 중복 있음, 공간 더 사용
  → JOIN 없이 바로 집계 가능
  → 읽기 성능 극대화
```

| 특성 | 정규화 | 비정규화 |
|------|--------|---------|
| 목적 | 쓰기 최적화 | 읽기 최적화 |
| 중복 | 없음 | 허용 |
| JOIN | 많음 | 적음 |
| UPDATE | 한 곳만 | 여러 곳 |
| 적합 | OLTP | OLAP, DW |

## 2. 스타 스키마

```
스타 스키마 (Star Schema):

  Ralph Kimball의 차원 모델링 핵심

              [dim_date]
                  │
  [dim_product]──[fact_sales]──[dim_customer]
                  │
              [dim_store]

  Fact 테이블 (사실):
  └─ 비즈니스 이벤트/측정값
     fact_sales: sale_id, date_key, product_key,
                 customer_key, store_key,
                 quantity, amount, discount

  Dimension 테이블 (차원):
  └─ Fact를 설명하는 속성
     dim_customer: customer_key, name, segment,
                   city, country, join_date

  이름의 유래: ERD가 별 모양 ★
```

```sql
-- 스타 스키마 쿼리: JOIN이 단순하고 직관적
SELECT
    d.year, d.quarter,
    p.category,
    c.segment,
    SUM(f.amount) AS total_revenue,
    COUNT(DISTINCT f.customer_key) AS unique_customers
FROM fact_sales f
JOIN dim_date d ON f.date_key = d.date_key
JOIN dim_product p ON f.product_key = p.product_key
JOIN dim_customer c ON f.customer_key = c.customer_key
WHERE d.year = 2024
GROUP BY d.year, d.quarter, p.category, c.segment;
```

> **핵심 직관**: 스타 스키마의 강점은 **"어떤 분석 질문이든 같은 패턴으로 쿼리"**할 수 있다는 것입니다. Fact + 필요한 Dimension JOIN + GROUP BY. 분석가가 즉시 이해하고 활용할 수 있습니다.

## 3. 스노우플레이크 스키마

```
스노우플레이크 스키마:

  Dimension을 추가로 정규화

  스타:
  fact_sales ── dim_product (category, brand 포함)

  스노우플레이크:
  fact_sales ── dim_product ── dim_category
                            ── dim_brand

  장점: 차원 테이블 크기 감소, 일관성
  단점: JOIN 증가, 쿼리 복잡
  실무: 대부분 스타 스키마 선호 (단순성 우선)
```

## 4. Slowly Changing Dimensions (SCD)

```
문제: 차원 속성이 시간에 따라 변하면?

  고객이 서울에서 부산으로 이사하면
  과거 주문은 "서울"로, 이후 주문은 "부산"으로 분석해야 함

SCD Type 1 (덮어쓰기):
  UPDATE dim_customer SET city = '부산' WHERE id = 42;
  → 히스토리 없음, 과거 분석 부정확
  적합: 오타 수정, 히스토리 불필요

SCD Type 2 (새 행 추가):
  customer_key | id | city | valid_from | valid_to   | is_current
  1001         | 42 | 서울 | 2020-01-01 | 2024-06-30 | N
  1002         | 42 | 부산 | 2024-07-01 | 9999-12-31 | Y

  → 완전한 히스토리, 시점 분석 가능
  → surrogate key(customer_key) 필수
  적합: 대부분의 비즈니스 차원

SCD Type 3 (컬럼 추가):
  id | current_city | previous_city
  42 | 부산         | 서울
  → 제한적 히스토리 (직전 값만)
  적합: 변경 전후 비교만 필요
```

> **핵심 직관**: SCD Type 2가 실무에서 가장 많이 사용됩니다. 핵심은 **surrogate key(대리 키)**입니다. natural key(id=42)는 같지만 surrogate key(1001, 1002)가 다르므로 Fact 테이블이 시점별로 올바른 차원을 참조합니다.

## 5. 데이터 모델링 레이어

```
Medallion Architecture (Bronze/Silver/Gold):

  Bronze (Raw):
  └─ 원천 데이터 그대로 저장
     JSON, CSV → Parquet 변환만
     스키마 변경 추적

  Silver (Cleaned):
  └─ 클렌징, 타입 변환, 중복 제거
     비즈니스 키 통합
     참조 무결성 검증

  Gold (Business):
  └─ 비즈니스 로직 적용
     스타 스키마 (Fact + Dimension)
     집계 테이블, KPI 지표

  dbt 프로젝트 매핑:
  models/
  ├── staging/    → Bronze → Silver
  ├── intermediate/ → Silver 내 변환
  └── marts/      → Gold (스타 스키마)


One Big Table (OBT):
  모든 차원을 Fact에 조인한 단일 테이블
  → JOIN 없이 즉시 분석
  → BI 도구에 최적
  → 단점: 크기 큼, 갱신 비용 높음
  적합: 대시보드 뒷단, 특정 도메인 마트
```

## 6. 모델링 안티패턴

```
흔한 실수:

  1. OLTP 스키마를 DW에 그대로 복사
     → 정규화된 50개 테이블 조인 → 느리고 복잡

  2. 모든 것을 하나의 Fact 테이블에
     → 컬럼 200개, NULL 투성이

  3. SCD를 고려하지 않음
     → "작년 서울 매출"이 올해와 다른 값

  4. Surrogate Key 없이 Natural Key만 사용
     → SCD Type 2 불가능
     → 원천 시스템 키 변경 시 대응 불가

  5. 날짜를 문자열로 저장
     → '2024-01-15' vs '2024/01/15' 불일치
     → dim_date와 조인하여 통일
```

데이터 모델은 dp-06의 품질 검증 대상이 되고, dp-10의 피처 스토어에서 ML 피처로 재활용됩니다.

## 핵심 정리

- **차원 모델링**은 Fact(측정값)와 Dimension(설명 속성)으로 분석에 최적화된 구조를 설계합니다
- **스타 스키마**는 직관적이고 쿼리 패턴이 일관되어 대부분의 DW에서 표준으로 사용됩니다
- **SCD Type 2**는 차원 변경 히스토리를 보존하며, surrogate key가 시점별 올바른 참조를 보장합니다
- **Medallion Architecture**(Bronze/Silver/Gold)로 데이터를 단계적으로 정제하여 품질과 재사용성을 높입니다
- OLTP 스키마를 DW에 그대로 복사하는 것이 가장 흔한 안티패턴이며, **목적에 맞는 비정규화**가 핵심입니다
