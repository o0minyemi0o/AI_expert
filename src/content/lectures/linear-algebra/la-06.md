# 양의 정부호 행렬

## 왜 양의 정부호 행렬을 배워야 하는가

가우시안 분포의 공분산 행렬은 반드시 양의 반정부호(PSD)여야 합니다. 최적화에서 Hessian이 양의 정부호(PD)이면 극소점이 보장됩니다. 커널 함수가 유효하려면 Gram 행렬이 PSD여야 합니다. **양의 정부호성은 ML의 여러 이론이 성립하기 위한 전제 조건**입니다.

이번 강의에서는 PD/PSD의 정의, 동치 조건, Cholesky 분해, 그리고 ML에서의 응용을 다룹니다.

---

## 1. 정의

대칭 행렬 $A \in \mathbb{R}^{n \times n}$ ($A = A^T$)에 대해,

**양의 정부호 (Positive Definite, PD)**:
$$
\mathbf{x}^T A \mathbf{x} > 0 \quad \text{for all } \mathbf{x} \neq \mathbf{0}
$$

**양의 반정부호 (Positive Semi-Definite, PSD)**:
$$
\mathbf{x}^T A \mathbf{x} \geq 0 \quad \text{for all } \mathbf{x}
$$

$\mathbf{x}^TA\mathbf{x}$를 **이차 형식(quadratic form)**이라 합니다. PD란 "모든 방향에서 이차 형식이 양수"라는 뜻입니다.

> **핵심 직관**: 2차원에서 $f(\mathbf{x}) = \mathbf{x}^TA\mathbf{x}$의 등고선을 그리면, PD 행렬은 **타원**(모든 방향으로 위로 볼록)이고, 부정부호(indefinite) 행렬은 **안장 형태**(어떤 방향은 위로, 어떤 방향은 아래로)입니다.

---

## 2. 동치 조건 5가지

대칭 행렬 $A$에 대해 다음은 모두 **동치**입니다.

| # | 조건 |
|---|------|
| 1 | $\mathbf{x}^TA\mathbf{x} > 0$ for all $\mathbf{x} \neq \mathbf{0}$ (정의) |
| 2 | 모든 고유값이 **양수**: $\lambda_i > 0$ for all $i$ |
| 3 | 모든 **선행 주소행렬식(leading principal minor)**이 양수 |
| 4 | **Cholesky 분해**가 존재: $A = LL^T$ ($L$은 양의 대각 원소를 가진 하삼각 행렬) |
| 5 | $A = B^TB$ for some 가역 행렬 $B$ |

### 조건 2의 직관

스펙트럴 정리에 의해 $A = Q\Lambda Q^T$이므로,

$$
\mathbf{x}^TA\mathbf{x} = \mathbf{x}^TQ\Lambda Q^T\mathbf{x} = \mathbf{z}^T\Lambda\mathbf{z} = \sum_i \lambda_i z_i^2
$$

여기서 $\mathbf{z} = Q^T\mathbf{x}$입니다. 모든 $\lambda_i > 0$이면, $\mathbf{z} \neq \mathbf{0}$일 때 합이 반드시 양수입니다.

### 조건 3의 예시

$$
A = \begin{pmatrix} 2 & 1 \\ 1 & 3 \end{pmatrix}
$$

- $a_{11} = 2 > 0$ ✓
- $\det(A) = 6 - 1 = 5 > 0$ ✓

따라서 $A$는 PD입니다.

---

## 3. Cholesky 분해

PD 행렬 $A$는 유일하게 다음과 같이 분해됩니다.

$$
A = LL^T
$$

$L$은 양의 대각 원소를 가진 **하삼각 행렬(lower triangular matrix)**입니다.

### 계산 과정

$2 \times 2$ 예시:

$$
\begin{pmatrix} 4 & 2 \\ 2 & 5 \end{pmatrix} = \begin{pmatrix} l_{11} & 0 \\ l_{21} & l_{22} \end{pmatrix}\begin{pmatrix} l_{11} & l_{21} \\ 0 & l_{22} \end{pmatrix}
$$

전개하면,
- $l_{11}^2 = 4 \implies l_{11} = 2$
- $l_{21} l_{11} = 2 \implies l_{21} = 1$
- $l_{21}^2 + l_{22}^2 = 5 \implies l_{22} = 2$

$$
L = \begin{pmatrix} 2 & 0 \\ 1 & 2 \end{pmatrix}
$$

### 왜 유용한가

| 용도 | 설명 |
|------|------|
| 선형 시스템 풀기 | $A\mathbf{x} = \mathbf{b}$를 $LL^T\mathbf{x} = \mathbf{b}$로 → 전진/후진 대입 |
| 계산 비용 | $O(n^3/3)$ — LU 분해의 절반 |
| 수치 안정성 | 피벗팅 불필요 |
| 가우시안 샘플링 | $\mathbf{x} = L\mathbf{z} + \boldsymbol{\mu}$, $\mathbf{z} \sim \mathcal{N}(\mathbf{0}, I)$ |

> **핵심 직관**: Cholesky 분해는 "행렬의 제곱근"입니다. $A = LL^T$에서 $L$이 $A$의 제곱근 역할을 합니다.

---

## 4. Gram 행렬

벡터 $\mathbf{v}_1, \ldots, \mathbf{v}_k$의 **Gram 행렬**은,

$$
G_{ij} = \mathbf{v}_i^T\mathbf{v}_j
$$

행렬 형태로는,

$$
G = V^TV, \quad V = \begin{pmatrix} \mathbf{v}_1 & \cdots & \mathbf{v}_k \end{pmatrix}
$$

Gram 행렬은 **항상 PSD**입니다. 증명:

$$
\mathbf{x}^TG\mathbf{x} = \mathbf{x}^TV^TV\mathbf{x} = (V\mathbf{x})^T(V\mathbf{x}) = \|V\mathbf{x}\|^2 \geq 0
$$

$V$가 full column rank이면(벡터들이 선형 독립이면), 등호는 $\mathbf{x} = \mathbf{0}$일 때만 성립하므로 PD가 됩니다.

---

## 5. 공분산 행렬

$n$개의 데이터 포인트 $\mathbf{x}_1, \ldots, \mathbf{x}_n \in \mathbb{R}^d$ (중심화 완료)를 행으로 모은 행렬 $X \in \mathbb{R}^{n \times d}$에 대해,

$$
\Sigma = \frac{1}{n-1}X^TX
$$

이것은 Gram 행렬의 상수배이므로 **항상 PSD**입니다.

공분산 행렬이 PD가 아닌(PSD인) 경우:
- $n < d$: 샘플 수가 특성 수보다 적음 → $X$가 full column rank가 아님
- 완벽하게 상관된 특성이 존재

이런 경우 정규화(ridge: $\Sigma + \lambda I$)로 PD를 보장합니다.

---

## 6. NumPy로 확인하기

```python
import numpy as np

# PD 판별
A = np.array([[2, 1],
              [1, 3]])

eigenvalues = np.linalg.eigvalsh(A)  # 대칭 행렬용
print(f"고유값: {eigenvalues}")       # [1.38, 3.62] 모두 양수 → PD

# Cholesky 분해
L = np.linalg.cholesky(A)
print(f"L:\n{L}")
print(f"L @ L^T:\n{L @ L.T}")       # 원래 A와 같음

# 가우시안 샘플링
mean = np.array([0, 0])
n_samples = 1000
z = np.random.randn(n_samples, 2)
samples = z @ L.T + mean             # x = Lz + μ

print(f"샘플 공분산:\n{np.cov(samples.T).round(2)}")  # A에 근사

# PSD 검증: Gram 행렬
V = np.random.randn(3, 5)
G = V.T @ V
eigvals_G = np.linalg.eigvalsh(G)
print(f"\nGram 행렬 고유값: {eigvals_G.round(4)}")  # 모두 ≥ 0

# 특이(singular) 공분산 행렬 + Ridge
np.random.seed(0)
X = np.random.randn(3, 5)  # n < d
cov = X.T @ X / 2
rank = np.linalg.matrix_rank(cov)
print(f"\n공분산 rank: {rank} (d={5})")  # rank < d → PSD지만 PD 아님

# Ridge 정규화로 PD 만들기
cov_ridge = cov + 0.1 * np.eye(5)
print(f"Ridge 후 최소 고유값: {np.linalg.eigvalsh(cov_ridge).min():.4f}")  # > 0
```

---

## 7. ML에서의 의미

### 가우시안 분포

다변량 가우시안 $\mathcal{N}(\boldsymbol{\mu}, \Sigma)$의 확률 밀도는,

$$
p(\mathbf{x}) = \frac{1}{(2\pi)^{d/2}|\Sigma|^{1/2}} \exp\left(-\frac{1}{2}(\mathbf{x}-\boldsymbol{\mu})^T\Sigma^{-1}(\mathbf{x}-\boldsymbol{\mu})\right)
$$

$\Sigma$가 PD여야 $|\Sigma| > 0$이고 $\Sigma^{-1}$이 존재합니다. PSD이지만 PD가 아니면 밀도 함수가 정의되지 않습니다 (degenerate distribution).

### 최적화에서의 볼록성

함수 $f$의 Hessian $H$가 모든 점에서 PSD이면, $f$는 **볼록 함수(convex function)**입니다. 볼록 함수는 모든 극소점이 전역 최소점이므로, 최적화가 쉽습니다.

$$
H \succeq 0 \text{ everywhere} \iff f \text{ is convex}
$$

### 커널 함수

유효한 커널 함수 $k(\mathbf{x}_i, \mathbf{x}_j)$는 모든 유한 데이터셋에 대해 Gram 행렬 $K_{ij} = k(\mathbf{x}_i, \mathbf{x}_j)$가 PSD여야 합니다 (Mercer's theorem). 이것이 커널의 "유효성 조건"입니다.

---

## 핵심 정리

1. **양의 정부호(PD)**: 모든 $\mathbf{x} \neq \mathbf{0}$에 대해 $\mathbf{x}^TA\mathbf{x} > 0$이며, 고유값이 모두 양수인 것과 동치이다.
2. **Cholesky 분해** $A = LL^T$는 PD 행렬의 "제곱근"이며, LU 분해보다 2배 빠르다.
3. **Gram 행렬** $G = V^TV$는 항상 PSD이며, 공분산 행렬이 그 대표적 예이다.
4. 가우시안 분포, 볼록 최적화, 커널 함수의 유효성이 모두 **PD/PSD 조건**에 의존한다.
5. 데이터가 부족할 때($n < d$) 공분산이 PD가 아닐 수 있으며, **Ridge 정규화** $\Sigma + \lambda I$로 해결한다.
