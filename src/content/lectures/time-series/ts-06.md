# 스펙트럼 분석: 주파수 도메인, 파워 스펙트럼, 주기도, 웰치

## 왜 주파수 도메인 분석을 하는가

지금까지의 시계열 분석은 시간 도메인(time domain)에서 이루어졌습니다. 스펙트럼 분석은 시계열을 **주파수 도메인(frequency domain)**으로 변환하여, 어떤 주기 성분이 데이터를 지배하는지를 파악합니다. 시간 도메인에서 놓치기 쉬운 숨은 주기성을 발견할 수 있으며, ts-01에서 다룬 ACF와 스펙트럼은 수학적으로 정확히 대응(푸리에 변환 쌍)됩니다.

---

## 1. 시간 도메인과 주파수 도메인

### 1.1 기본 개념

정상 시계열 $Y_t$는 다양한 주파수의 사인/코사인 파동의 중첩으로 표현할 수 있습니다.

$$Y_t = \sum_{k} \left[ A_k \cos(2\pi f_k t) + B_k \sin(2\pi f_k t) \right]$$

| 비교 항목 | 시간 도메인 | 주파수 도메인 |
|----------|-----------|-------------|
| 기본 단위 | 시점 $t$ | 주파수 $f$ |
| 핵심 도구 | ACF, PACF | 스펙트럼 밀도 |
| 파악 가능 | 자기상관 구조 | 주기적 패턴 |
| 변환 | — | 푸리에 변환 |
| 대표 질문 | "과거와 얼마나 상관?" | "어떤 주기가 지배적?" |

> **핵심 직관**: 시간 도메인이 "언제"를 보여준다면, 주파수 도메인은 "얼마나 빠르게 반복되는지"를 보여줍니다.

---

## 2. 스펙트럼 밀도 함수

### 2.1 정의

정상 시계열의 자기공분산 함수 $\gamma(h)$의 푸리에 변환이 **스펙트럼 밀도 함수** $S(f)$입니다.

$$S(f) = \sum_{h=-\infty}^{\infty} \gamma(h) e^{-i 2\pi f h}, \quad -\frac{1}{2} \leq f \leq \frac{1}{2}$$

역변환:

$$\gamma(h) = \int_{-1/2}^{1/2} S(f) e^{i 2\pi f h} \, df$$

특히 $h=0$일 때:

$$\gamma(0) = \text{Var}(Y_t) = \int_{-1/2}^{1/2} S(f) \, df$$

### 2.2 대표적 모델의 스펙트럼

| 모델 | 스펙트럼 밀도 $S(f)$ | 형태 |
|------|-------------------|------|
| 백색 잡음 | $\sigma^2$ (상수) | 수평선 |
| AR(1), $\phi>0$ | $\frac{\sigma^2}{\lvert 1-\phi e^{-i2\pi f}\rvert^2}$ | 저주파에서 높음 |
| MA(1), $\theta>0$ | $\sigma^2 \lvert 1+\theta e^{-i2\pi f}\rvert^2$ | 고주파에서 높음 |

> **핵심 직관**: ACF와 스펙트럼은 **푸리에 변환 쌍**입니다. 하나를 알면 다른 하나를 완전히 결정할 수 있습니다.

```python
import numpy as np

# AR(1) 스펙트럼 이론값
phi = 0.8
sigma2 = 1.0
freqs = np.linspace(0, 0.5, 500)
spectrum = sigma2 / np.abs(1 - phi * np.exp(-2j * np.pi * freqs))**2

import matplotlib.pyplot as plt
plt.plot(freqs, spectrum)
plt.xlabel('주파수 (f)')
plt.ylabel('스펙트럼 밀도 S(f)')
plt.title('AR(1) 이론적 스펙트럼')
```

---

## 3. 주기도 (Periodogram)

주기도는 스펙트럼 밀도의 가장 기본적인 추정량입니다.

### 3.1 이산 푸리에 변환 (DFT)

$$J(f_k) = \frac{1}{\sqrt{T}} \sum_{t=1}^{T} Y_t e^{-i 2\pi f_k t}, \quad f_k = \frac{k}{T}$$

### 3.2 주기도

$$I(f_k) = |J(f_k)|^2 = \frac{1}{T} \left| \sum_{t=1}^{T} Y_t e^{-i 2\pi f_k t} \right|^2$$

| 성질 | 설명 |
|------|------|
| 비편향성 | $E[I(f)] = S(f)$ (근사적) |
| 비일치성 | $\text{Var}(I(f)) \not\to 0$ ($T \to \infty$일 때) |
| 분해능 | $\Delta f = 1/T$ |
| 주파수 범위 | $0$ ~ $f_{Ny} = 1/(2\Delta t)$ |

> **핵심 직관**: 주기도는 "각 주파수에 에너지가 얼마나 집중되어 있는가"를 보여주지만, 분산이 줄지 않아 **그대로 쓰면 불안정**합니다.

```python
from scipy.signal import periodogram

freqs, psd = periodogram(ts.values, fs=1.0)

plt.figure(figsize=(10, 4))
plt.semilogy(freqs, psd)
plt.xlabel('주파수')
plt.ylabel('파워 스펙트럼 밀도')
plt.title('주기도 (Periodogram)')
```

---

## 4. 스펙트럼 추정 개선 방법

### 4.1 웰치 방법 (Welch's Method)

데이터를 겹치는 구간으로 나누어 각 구간의 주기도를 평균합니다.

| 파라미터 | 설명 | 효과 |
|---------|------|------|
| `nperseg` | 세그먼트 길이 | 길수록 분해능↑, 평활↓ |
| `noverlap` | 겹침 길이 | 50%가 일반적 |
| `window` | 창 함수 | 'hann'이 기본 |

```python
from scipy.signal import welch

freqs_w, psd_w = welch(ts.values, fs=1.0, nperseg=256, noverlap=128)

plt.semilogy(freqs_w, psd_w)
plt.xlabel('주파수')
plt.ylabel('파워 스펙트럼 밀도')
plt.title('웰치 방법')
```

### 4.2 다른 방법들

| 방법 | 원리 | 장점 | 단점 |
|------|------|------|------|
| 주기도 | 원시 DFT | 단순, 빠름 | 분산 큼 |
| 웰치 | 분할 + 평균 | 분산 감소 | 분해능 감소 |
| 다중 테이퍼 (Multitaper) | 직교 테이퍼 함수 | 편향-분산 균형 우수 | 구현 복잡 |
| AR 스펙트럼 | AR 모델 피팅 | 매끄러운 추정 | 모델 가정 필요 |

> **핵심 직관**: 스펙트럼 추정에는 **분해능-분산 트레이드오프**가 존재합니다. 웰치는 분산을 줄이되 분해능을 희생합니다.

---

## 5. 나이퀴스트 주파수와 앨리어싱

### 5.1 나이퀴스트 정리

샘플링 주파수 $f_s$로 관측된 시계열에서 식별 가능한 최대 주파수는:

$$f_{Ny} = \frac{f_s}{2}$$

### 5.2 앨리어싱 (Aliasing)

$f_{Ny}$보다 높은 주파수 성분이 있으면, 낮은 주파수로 잘못 나타나는 현상입니다.

| 샘플링 간격 | 샘플링 주파수 | 나이퀴스트 주파수 | 식별 가능 주기 |
|-----------|------------|---------------|-------------|
| 1일 | 1/일 | 0.5/일 | 2일 이상 |
| 1월 | 1/월 | 0.5/월 | 2월 이상 |
| 1시간 | 1/시간 | 0.5/시간 | 2시간 이상 |

> **핵심 직관**: 월별 데이터로는 2개월보다 짧은 주기를 감지할 수 없습니다. 이것이 **나이퀴스트 한계**입니다.

---

## 6. 실무 활용 예시

### 6.1 숨은 주기 탐지

```python
import numpy as np
from scipy.signal import welch

# 여러 주기가 혼합된 시계열
np.random.seed(42)
t = np.arange(1000)
y = (3 * np.sin(2 * np.pi * t / 50) +    # 주기 50
     1.5 * np.sin(2 * np.pi * t / 12) +   # 주기 12
     np.random.randn(1000))                # 잡음

freqs, psd = welch(y, fs=1.0, nperseg=256)
# 피크 주파수 찾기
peak_freqs = freqs[np.argsort(psd)[-3:]]
print(f"피크 주파수: {peak_freqs}")
print(f"대응 주기: {1/peak_freqs}")
```

### 6.2 스펙트럼과 ACF의 관계

| ACF 특성 | 스펙트럼 특성 | 해석 |
|---------|-------------|------|
| 느린 감소 | 저주파 피크 | 장기 의존성 |
| 주기적 진동 | 특정 주파수 피크 | 계절성 |
| 급격한 절단 | 매끄러운 스펙트럼 | MA 과정 |
| 빠른 지수 감소 | 넓은 피크 | AR(1) |

> **핵심 직관**: 스펙트럼의 피크는 시계열에 숨어 있는 **주기적 패턴**을 직접적으로 가리킵니다. ACF에서 모호한 주기성도 스펙트럼에서는 명확하게 보입니다.

---

## 7. 시간-주파수 분석 맛보기

정상성 가정이 위반될 때, 시간에 따라 스펙트럼이 변할 수 있습니다.

| 방법 | 설명 | 장점 |
|------|------|------|
| STFT (단시간 푸리에 변환) | 윈도우를 이동하며 DFT | 직관적 |
| 웨이블릿 변환 | 다중 스케일 분석 | 시간-주파수 분해능 가변 |
| 힐베르트-황 변환 (HHT) | 경험적 모드 분해 | 비선형/비정상에 적합 |

```python
from scipy.signal import stft

f_stft, t_stft, Zxx = stft(y, fs=1.0, nperseg=128)
plt.pcolormesh(t_stft, f_stft, np.abs(Zxx), shading='gouraud')
plt.ylabel('주파수')
plt.xlabel('시간')
plt.title('STFT 스펙트로그램')
plt.colorbar(label='크기')
```

> **핵심 직관**: 비정상 시계열에서는 "시간에 따라 주파수 구성이 변하므로", 시간과 주파수를 동시에 보는 도구가 필요합니다.

---

## 핵심 정리

- **스펙트럼 밀도 함수는 자기공분산 함수의 푸리에 변환으로, 시계열의 주파수별 에너지 분포를 보여줍니다.**
- **주기도는 스펙트럼 밀도의 기본 추정량이지만 분산이 크므로, 웰치·다중 테이퍼 등으로 평활화해야 합니다.**
- **나이퀴스트 주파수는 샘플링 주파수의 절반이며, 이보다 높은 주파수는 앨리어싱으로 왜곡됩니다.**
- **스펙트럼의 피크는 시계열에 숨어 있는 주기적 패턴을 직접 가리키며, ACF보다 주기 탐지에 효과적입니다.**
- **비정상 시계열에서는 STFT나 웨이블릿 변환을 사용하여 시간에 따라 변하는 주파수 구조를 분석합니다.**
