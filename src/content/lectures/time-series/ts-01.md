# 시계열의 기초 개념: 정상성, ACF, PACF, 시계열 분해

## 왜 시계열을 이해해야 하는가

시계열 데이터는 시간 순서에 따라 관측된 데이터로, 금융·기상·의료 등 거의 모든 산업 분야에서 핵심적인 역할을 합니다. 일반적인 횡단면 데이터와 달리 시계열에는 **시간 의존성**이 존재하므로, 이를 올바르게 모델링하려면 정상성·자기상관·계절성 등 고유한 개념을 먼저 이해해야 합니다. 이 강의에서는 시계열 분석의 출발점이 되는 네 가지 핵심 도구를 다룹니다.

---

## 1. 시계열 데이터의 정의와 표현

시계열(time series)은 시간 인덱스 $t$에 대해 관측된 확률 변수의 수열 $\{Y_t\}_{t=1}^{T}$입니다.

| 구분 | 횡단면 데이터 | 시계열 데이터 |
|------|-------------|-------------|
| 관측 축 | 개체(i) | 시간(t) |
| 독립성 가정 | 보통 성립 | 대부분 위반 |
| 순서 중요성 | 없음 | 있음 |
| 대표 예시 | 설문조사 응답 | 일별 주가 |

> **핵심 직관**: 시계열에서는 관측값의 **순서** 자체가 정보입니다. 셔플하면 구조가 사라집니다.

```python
import pandas as pd
import numpy as np

# 시계열 데이터 생성
dates = pd.date_range('2020-01-01', periods=365, freq='D')
y = np.cumsum(np.random.randn(365))  # 랜덤 워크
ts = pd.Series(y, index=dates)
ts.plot(title='랜덤 워크 시계열')
```

월별 항공 승객 수는 계절성과 추세를 가집니다.

---

## 2. 정상성 (Stationarity)

정상성은 시계열 분석의 가장 중요한 가정입니다. **약정상(weakly stationary)** 시계열은 다음 조건을 만족합니다.

$$E[Y_t] = \mu \quad \text{(상수 평균)}$$

$$\text{Var}(Y_t) = \sigma^2 \quad \text{(상수 분산)}$$

$$\text{Cov}(Y_t, Y_{t+h}) = \gamma(h) \quad \text{(시차에만 의존)}$$

| 성질 | 정상 시계열 | 비정상 시계열 |
|------|-----------|-------------|
| 평균 | 시간 불변 | 시간에 따라 변화 |
| 분산 | 시간 불변 | 시간에 따라 변화 |
| 자기공분산 | 시차 $h$에만 의존 | $t$와 $h$ 모두에 의존 |
| 예시 | 주식 수익률 | 주가 수준 |

> **핵심 직관**: 정상 시계열은 "어디를 잘라봐도 통계적 성질이 같은" 시계열입니다.

주식 수익률은 정상 시계열에 가깝습니다. 반면 주가 자체는 비정상 시계열입니다.

**강정상(strictly stationary)**은 $(Y_{t_1}, \ldots, Y_{t_k})$의 결합 분포가 시간 이동에 불변인 더 강한 조건이지만, 실무에서는 약정상을 주로 사용합니다.

---

## 3. 자기상관함수 (ACF)와 편자기상관함수 (PACF)

### 3.1 ACF (Autocorrelation Function)

시차 $h$에서의 자기상관은 다음과 같이 정의됩니다.

$$\rho(h) = \frac{\gamma(h)}{\gamma(0)} = \frac{\text{Cov}(Y_t, Y_{t+h})}{\text{Var}(Y_t)}$$

### 3.2 PACF (Partial Autocorrelation Function)

편자기상관은 중간 시차의 영향을 제거한 후 $Y_t$와 $Y_{t+h}$ 사이의 순수한 상관을 측정합니다. la-04에서 다룬 직교 사영의 개념과 유사하게, 중간 변수의 효과를 "빼내는" 과정입니다.

$$\phi_{hh} = \text{Corr}(Y_t - \hat{Y}_t, \, Y_{t+h} - \hat{Y}_{t+h})$$

여기서 $\hat{Y}_t$와 $\hat{Y}_{t+h}$는 $Y_{t+1}, \ldots, Y_{t+h-1}$에 대한 선형 사영입니다.

| 모델 | ACF 패턴 | PACF 패턴 |
|------|---------|----------|
| AR(p) | 지수적 감소 | 시차 p 이후 절단 |
| MA(q) | 시차 q 이후 절단 | 지수적 감소 |
| ARMA(p,q) | 지수적 감소 | 지수적 감소 |

> **핵심 직관**: ACF와 PACF의 절단/감소 패턴은 적절한 모델 차수를 식별하는 **지문**과 같습니다.

```python
from statsmodels.graphics.tsaplots import plot_acf, plot_pacf

fig, axes = plt.subplots(1, 2, figsize=(12, 4))
plot_acf(ts, lags=30, ax=axes[0], title='ACF')
plot_pacf(ts, lags=30, ax=axes[1], title='PACF')
plt.tight_layout()
```

---

## 4. 시계열 분해 (Decomposition)

시계열을 추세(Trend), 계절성(Seasonal), 잔차(Residual)로 분리하는 기법입니다.

### 4.1 가법 모델과 승법 모델

$$Y_t = T_t + S_t + R_t \quad \text{(가법 모델)}$$

$$Y_t = T_t \times S_t \times R_t \quad \text{(승법 모델)}$$

| 구분 | 가법 모델 | 승법 모델 |
|------|---------|---------|
| 계절 변동 | 일정한 크기 | 추세에 비례 |
| 적합 상황 | 변동 폭 일정 | 변동 폭 증가 |
| 변환 | 그대로 사용 | 로그 변환 → 가법 |

> **핵심 직관**: 계절 변동의 크기가 추세와 함께 커지면 승법 모델, 일정하면 가법 모델을 선택합니다.

### 4.2 STL 분해

STL(Seasonal and Trend decomposition using Loess)은 이동평균 기반 분해보다 로버스트한 방법입니다.

```python
from statsmodels.tsa.seasonal import STL

# 월별 항공 승객 데이터
from statsmodels.datasets import co2
data = co2.load().data.resample('M').mean().ffill()

stl = STL(data, period=12, robust=True)
result = stl.fit()
result.plot()
```

---

## 5. 백색 잡음과 기본 검정

### 5.1 백색 잡음 (White Noise)

$$\epsilon_t \sim WN(0, \sigma^2)$$

백색 잡음은 평균 0, 일정 분산, 그리고 모든 시차에서 자기상관이 0인 시계열입니다.

### 5.2 Ljung-Box 검정

잔차가 백색 잡음인지 검정합니다. 귀무가설: "시차 $m$까지의 자기상관이 모두 0이다."

$$Q(m) = T(T+2) \sum_{h=1}^{m} \frac{\hat{\rho}(h)^2}{T-h} \sim \chi^2(m)$$

```python
from statsmodels.stats.diagnostic import acorr_ljungbox

result = acorr_ljungbox(residuals, lags=10, return_df=True)
print(result)  # p-value > 0.05이면 백색 잡음
```

> **핵심 직관**: 좋은 시계열 모델의 잔차는 백색 잡음이어야 합니다. 잔차에 구조가 남아 있으면 모델이 불완전합니다.

---

## 6. 실무 워크플로우

시계열 분석의 기본 워크플로우는 다음과 같습니다.

| 단계 | 작업 | 도구 |
|------|------|------|
| 1 | 시각화 및 탐색 | 시계열 플롯, 히스토그램 |
| 2 | 정상성 검정 | ADF 검정 (ts-08 참조) |
| 3 | 정상화 변환 | 차분, 로그 변환 |
| 4 | ACF/PACF 분석 | 상관도표 |
| 5 | 모델 식별/추정 | AIC/BIC, MLE (si-02에서 배운 MLE 참조) |
| 6 | 진단 검정 | Ljung-Box, 잔차 분석 |
| 7 | 예측 | 점 예측 + 구간 예측 |

> **핵심 직관**: 시계열 분석은 "시각화 → 정상화 → 모델링 → 진단"의 반복적 과정입니다.

---

## 핵심 정리

- **시계열은 시간 의존성을 가진 순서 데이터이며, 관측값의 순서 자체가 중요한 정보를 담고 있습니다.**
- **정상성(약정상)은 평균·분산·자기공분산이 시간에 불변인 성질로, 대부분의 시계열 모델의 기본 가정입니다.**
- **ACF는 시차별 상관을, PACF는 중간 시차를 제거한 순수 상관을 측정하며, 모델 차수 식별의 핵심 도구입니다.**
- **시계열 분해는 추세·계절성·잔차를 분리하여 데이터의 구조를 파악하는 기법이며, STL이 로버스트한 대안입니다.**
- **좋은 모델의 잔차는 백색 잡음이어야 하며, Ljung-Box 검정으로 이를 확인할 수 있습니다.**
