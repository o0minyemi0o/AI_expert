# 상태 공간 모델과 칼만 필터: 상태 공간, 칼만 필터/스무더

## 왜 상태 공간 모델과 칼만 필터를 배우는가

상태 공간 모델은 시계열 모델링의 **통합 프레임워크**입니다. ts-02에서 배운 ARIMA, ts-04에서 배운 ETS 모두 상태 공간 형태로 표현할 수 있으며, 관측할 수 없는 잠재 상태를 추적하는 데 핵심적인 도구입니다. 칼만 필터는 이 상태 공간 모델에서 최적의 상태 추정을 제공하는 알고리즘으로, 항법·금융·신호처리 등 광범위한 분야에서 사용됩니다.

---

## 1. 상태 공간 모델의 구조

상태 공간 모델은 두 개의 방정식으로 구성됩니다.

### 상태 방정식 (State Equation)

$$\mathbf{x}_t = \mathbf{F}_t \mathbf{x}_{t-1} + \mathbf{B}_t \mathbf{u}_t + \mathbf{w}_t, \quad \mathbf{w}_t \sim N(\mathbf{0}, \mathbf{Q}_t)$$

### 관측 방정식 (Observation Equation)

$$\mathbf{y}_t = \mathbf{H}_t \mathbf{x}_t + \mathbf{v}_t, \quad \mathbf{v}_t \sim N(\mathbf{0}, \mathbf{R}_t)$$

| 기호 | 의미 | 차원 |
|------|------|------|
| $\mathbf{x}_t$ | 상태 벡터 (잠재) | $n \times 1$ |
| $\mathbf{y}_t$ | 관측 벡터 | $m \times 1$ |
| $\mathbf{F}_t$ | 상태 전이 행렬 | $n \times n$ |
| $\mathbf{H}_t$ | 관측 행렬 | $m \times n$ |
| $\mathbf{Q}_t$ | 상태 잡음 공분산 | $n \times n$ |
| $\mathbf{R}_t$ | 관측 잡음 공분산 | $m \times m$ |

> **핵심 직관**: 상태 공간 모델은 "보이지 않는 진짜 상태"와 "잡음이 섞인 관측"을 분리하여 생각합니다.

---

## 2. 시계열 모델의 상태 공간 표현

### 2.1 로컬 레벨 모델 (Local Level Model)

가장 단순한 상태 공간 모델로, ETS(A,N,N)과 동치입니다.

$$\mu_t = \mu_{t-1} + \eta_t, \quad \eta_t \sim N(0, \sigma_\eta^2)$$

$$Y_t = \mu_t + \epsilon_t, \quad \epsilon_t \sim N(0, \sigma_\epsilon^2)$$

### 2.2 로컬 선형 추세 모델

ETS(A,A,N)에 대응합니다.

$$\mu_t = \mu_{t-1} + \beta_{t-1} + \eta_t$$

$$\beta_t = \beta_{t-1} + \zeta_t$$

$$Y_t = \mu_t + \epsilon_t$$

### 2.3 ARIMA의 상태 공간 표현

ARIMA(1,1,1)을 상태 공간으로:

$$\mathbf{x}_t = \begin{pmatrix} Y_t \\ \epsilon_t \end{pmatrix}, \quad \mathbf{F} = \begin{pmatrix} 1+\phi & \theta \\ 0 & 0 \end{pmatrix}$$

| 시계열 모델 | 상태 차원 | 상태의 의미 |
|-----------|---------|-----------|
| 로컬 레벨 | 1 | 수준 |
| 로컬 선형 추세 | 2 | 수준, 기울기 |
| 계절 모델 | $s$ | 수준, 계절 요소들 |
| ARIMA(p,d,q) | $\max(p,q+1)$ | 과거 값/오차 |

> **핵심 직관**: 거의 모든 선형 시계열 모델은 상태 공간으로 표현할 수 있으며, 이를 통해 칼만 필터라는 **하나의 알고리즘**으로 통합 처리됩니다.

---

## 3. 칼만 필터 (Kalman Filter)

칼만 필터는 선형 가우시안 상태 공간 모델에서 **최적의 상태 추정**을 제공하는 재귀 알고리즘입니다.

### 3.1 예측 단계 (Prediction)

$$\hat{\mathbf{x}}_{t|t-1} = \mathbf{F} \hat{\mathbf{x}}_{t-1|t-1}$$

$$\mathbf{P}_{t|t-1} = \mathbf{F} \mathbf{P}_{t-1|t-1} \mathbf{F}^\top + \mathbf{Q}$$

### 3.2 갱신 단계 (Update)

혁신(innovation):

$$\mathbf{e}_t = \mathbf{y}_t - \mathbf{H} \hat{\mathbf{x}}_{t|t-1}$$

칼만 이득(Kalman gain):

$$\mathbf{K}_t = \mathbf{P}_{t|t-1} \mathbf{H}^\top (\mathbf{H} \mathbf{P}_{t|t-1} \mathbf{H}^\top + \mathbf{R})^{-1}$$

상태 갱신:

$$\hat{\mathbf{x}}_{t|t} = \hat{\mathbf{x}}_{t|t-1} + \mathbf{K}_t \mathbf{e}_t$$

$$\mathbf{P}_{t|t} = (\mathbf{I} - \mathbf{K}_t \mathbf{H}) \mathbf{P}_{t|t-1}$$

| 단계 | 입력 | 출력 | 의미 |
|------|------|------|------|
| 예측 | $\hat{\mathbf{x}}_{t-1\mid t-1}$ | $\hat{\mathbf{x}}_{t\mid t-1}$ | 다음 상태 사전 추정 |
| 혁신 | $\mathbf{y}_t$ | $\mathbf{e}_t$ | 예측 오차 |
| 갱신 | $\mathbf{e}_t, \mathbf{K}_t$ | $\hat{\mathbf{x}}_{t\mid t}$ | 관측 반영 후 사후 추정 |

> **핵심 직관**: 칼만 필터는 "예측 → 관측 → 수정"의 **베이지안 갱신**을 매 시점 반복합니다. la-04에서 다룬 사영의 개념과 연결됩니다.

```python
import numpy as np
from statsmodels.tsa.statespace.mlemodel import MLEModel

# statsmodels의 구조적 시계열 모델
from statsmodels.tsa.structural import UnobservedComponents

model = UnobservedComponents(ts, level='local linear trend')
result = model.fit(disp=False)
print(result.summary())
```

---

## 4. 칼만 스무더 (Kalman Smoother)

칼만 필터는 $t$ 시점까지의 정보만 사용하지만, 스무더는 **전체 데이터**를 사용하여 과거 상태를 더 정확히 추정합니다.

### RTS (Rauch-Tung-Striebel) 스무더

$t = T, T-1, \ldots, 1$ 순으로 역방향 계산:

$$\mathbf{L}_t = \mathbf{P}_{t|t} \mathbf{F}^\top \mathbf{P}_{t+1|t}^{-1}$$

$$\hat{\mathbf{x}}_{t|T} = \hat{\mathbf{x}}_{t|t} + \mathbf{L}_t (\hat{\mathbf{x}}_{t+1|T} - \hat{\mathbf{x}}_{t+1|t})$$

$$\mathbf{P}_{t|T} = \mathbf{P}_{t|t} + \mathbf{L}_t (\mathbf{P}_{t+1|T} - \mathbf{P}_{t+1|t}) \mathbf{L}_t^\top$$

| 방법 | 사용 정보 | 용도 | 표기 |
|------|---------|------|------|
| 필터링 | $y_1, \ldots, y_t$ | 실시간 추정 | $\hat{x}_{t\mid t}$ |
| 예측 | $y_1, \ldots, y_t$ | 미래 예측 | $\hat{x}_{t+h\mid t}$ |
| 스무딩 | $y_1, \ldots, y_T$ | 과거 상태 재추정 | $\hat{x}_{t\mid T}$ |

> **핵심 직관**: 필터는 "현재까지 아는 것으로 현재를 추정"하고, 스무더는 "미래까지 알고 나서 과거를 더 정확하게 재추정"합니다.

```python
# 칼만 스무더 결과 접근
filtered_state = result.filtered_state[0]
smoothed_state = result.smoothed_state[0]

import matplotlib.pyplot as plt
plt.figure(figsize=(12, 4))
plt.plot(ts, alpha=0.4, label='관측')
plt.plot(ts.index, filtered_state, label='필터링 (실시간)')
plt.plot(ts.index, smoothed_state, label='스무딩 (사후)', linestyle='--')
plt.legend()
plt.title('칼만 필터 vs 스무더')
```

---

## 5. 파라미터 추정과 우도 계산

칼만 필터는 혁신 $\mathbf{e}_t$와 그 분산을 통해 로그 우도를 효율적으로 계산합니다.

### 혁신 기반 우도

$$\ln L = -\frac{T}{2} \ln(2\pi) - \frac{1}{2} \sum_{t=1}^{T} \left[ \ln |\mathbf{S}_t| + \mathbf{e}_t^\top \mathbf{S}_t^{-1} \mathbf{e}_t \right]$$

여기서 $\mathbf{S}_t = \mathbf{H} \mathbf{P}_{t|t-1} \mathbf{H}^\top + \mathbf{R}$는 혁신 공분산입니다.

이를 si-02에서 배운 MLE로 최적화하여 $\mathbf{F}, \mathbf{H}, \mathbf{Q}, \mathbf{R}$의 미지 파라미터를 추정합니다.

| 추정 방법 | 장점 | 단점 |
|----------|------|------|
| MLE (혁신 우도) | 효율적, 점근적 최적 | 로컬 최적 문제 |
| EM 알고리즘 | 안정적 수렴 | 느림 |
| 베이지안 (MCMC) | 불확실성 정량화 | 계산 비용 |

> **핵심 직관**: 칼만 필터의 부산물인 혁신과 혁신 분산이 곧 우도 함수를 구성하며, 이를 최적화하면 파라미터를 추정할 수 있습니다.

---

## 6. 구조적 시계열 모델

상태 공간 프레임워크를 활용한 해석 가능한 분해 모델입니다.

$$Y_t = \mu_t + \gamma_t + c_t + \epsilon_t$$

| 성분 | 상태 방정식 | 의미 |
|------|-----------|------|
| 추세 $\mu_t$ | $\mu_t = \mu_{t-1} + \beta_{t-1} + \eta_t$ | 로컬 선형 추세 |
| 계절 $\gamma_t$ | $\gamma_t = -\sum_{j=1}^{s-1} \gamma_{t-j} + \omega_t$ | 계절 성분 |
| 순환 $c_t$ | AR(2) 과정 | 경기 순환 |
| 회귀 | $\mathbf{z}_t^\top \boldsymbol{\delta}$ | 외생 변수 효과 |

```python
from statsmodels.tsa.structural import UnobservedComponents

model = UnobservedComponents(
    ts_monthly,
    level='local linear trend',
    seasonal=12,
    stochastic_seasonal=True
)
result = model.fit(disp=False)
fig = result.plot_components(figsize=(12, 10))
```

> **핵심 직관**: 구조적 시계열 모델은 ts-01의 시계열 분해를 **통계 모델**로 만들어, 각 성분의 불확실성까지 추정합니다.

---

## 7. 비선형 확장: EKF와 UKF

선형 가우시안 가정이 성립하지 않을 때의 확장입니다.

| 방법 | 비선형 처리 | 계산 비용 | 정확도 |
|------|-----------|---------|-------|
| EKF (확장 칼만 필터) | 1차 테일러 근사 | 낮음 | 보통 |
| UKF (무향 칼만 필터) | 시그마 포인트 | 중간 | 높음 |
| 파티클 필터 | 몬테카를로 샘플링 | 높음 | 매우 높음 |

> **핵심 직관**: 비선형 시스템에서는 칼만 필터의 최적성이 깨지지만, EKF/UKF/파티클 필터로 근사할 수 있습니다.

---

## 핵심 정리

- **상태 공간 모델은 잠재 상태(상태 방정식)와 관측(관측 방정식)을 분리하는 통합 프레임워크입니다.**
- **ARIMA, ETS 등 대부분의 선형 시계열 모델은 상태 공간 형태로 표현할 수 있습니다.**
- **칼만 필터는 "예측 → 관측 → 갱신"의 재귀적 베이지안 추정으로, 선형 가우시안 모델에서 최적입니다.**
- **칼만 스무더는 전체 데이터를 활용하여 과거 상태를 더 정확하게 재추정하며, 필터링보다 항상 정확합니다.**
- **구조적 시계열 모델은 추세·계절·순환 성분을 상태 공간에서 분리하여, 해석 가능하고 유연한 분해를 제공합니다.**
