# Prophet과 현대 예측 도구: Facebook Prophet, 휴일 효과, 시계열 CV

## 왜 Prophet과 현대 예측 도구를 배우는가

ts-02~ts-04에서 배운 ARIMA와 ETS는 강력하지만, 실무에서는 다수의 시계열을 비전문가도 빠르게 예측해야 하는 상황이 자주 발생합니다. Facebook(Meta)이 개발한 Prophet은 추세 변화점, 다중 계절성, 휴일 효과를 자동 처리하며, 도메인 지식을 직관적으로 반영할 수 있는 실용적 예측 도구입니다. 이 강의에서는 Prophet의 원리와 함께 시계열 교차 검증 기법을 다룹니다.

---

## 1. Prophet 모델의 구조

Prophet은 GAM(Generalized Additive Model) 방식으로 시계열을 분해합니다.

$$y(t) = g(t) + s(t) + h(t) + \epsilon_t$$

| 성분 | 기호 | 설명 |
|------|------|------|
| 추세 | $g(t)$ | 성장 함수 (선형 또는 로지스틱) |
| 계절성 | $s(t)$ | 푸리에 급수 기반 주기 패턴 |
| 휴일 효과 | $h(t)$ | 특정 날짜의 이벤트 효과 |
| 오차 | $\epsilon_t$ | 정규 분포 잡음 |

> **핵심 직관**: Prophet은 ts-01의 시계열 분해와 같은 원리이지만, 각 성분을 유연하게 모델링하고 자동으로 변화점을 감지합니다.

```python
from prophet import Prophet
import pandas as pd

# Prophet 입력 형식: ds(날짜), y(값)
df = pd.DataFrame({'ds': dates, 'y': values})

model = Prophet()
model.fit(df)
future = model.make_future_dataframe(periods=365)
forecast = model.predict(future)
model.plot(forecast)
```

---

## 2. 추세 모델링

### 2.1 선형 추세 + 변화점

$$g(t) = (k + \mathbf{a}(t)^\top \boldsymbol{\delta}) \cdot t + (m + \mathbf{a}(t)^\top \boldsymbol{\gamma})$$

여기서 $\boldsymbol{\delta}$는 변화점에서의 기울기 변화량, $\mathbf{a}(t)$는 변화점 지시 벡터입니다.

### 2.2 로지스틱 성장

포화 용량(carrying capacity) $C$가 있을 때:

$$g(t) = \frac{C}{1 + \exp(-(k + \mathbf{a}(t)^\top \boldsymbol{\delta})(t - (m + \mathbf{a}(t)^\top \boldsymbol{\gamma})))}$$

| 추세 유형 | 적합 상황 | 예시 |
|----------|---------|------|
| 선형 | 제한 없는 성장 | 매출액 |
| 로지스틱 | 포화점 존재 | 앱 사용자 수, 시장 침투율 |
| 평탄 (flat) | 추세 없음 | 정상 시계열 |

```python
# 로지스틱 성장 모델
df['cap'] = 10000  # 포화점
df['floor'] = 0

model = Prophet(growth='logistic')
model.fit(df)
```

### 2.3 변화점 자동 탐지

Prophet은 라플라스 사전 분포로 변화점을 정규화합니다.

$$\delta_j \sim \text{Laplace}(0, \tau)$$

| 파라미터 | 기본값 | 효과 |
|---------|-------|------|
| `changepoint_prior_scale` | 0.05 | 클수록 유연 (과적합 위험) |
| `n_changepoints` | 25 | 후보 변화점 수 |
| `changepoint_range` | 0.8 | 데이터의 처음 80% 내에서 탐지 |

> **핵심 직관**: `changepoint_prior_scale`은 추세의 유연성을 조절하는 **가장 중요한 하이퍼파라미터**입니다. ts-08에서 배운 구조 변화 탐지와 연결됩니다.

---

## 3. 계절성 모델링

Prophet은 **푸리에 급수**로 계절성을 표현합니다.

$$s(t) = \sum_{n=1}^{N} \left[ a_n \cos\left(\frac{2\pi n t}{P}\right) + b_n \sin\left(\frac{2\pi n t}{P}\right) \right]$$

여기서 $P$는 주기(연간=365.25, 주간=7), $N$은 푸리에 차수입니다. ts-06에서 배운 주파수 분석의 원리가 직접 적용됩니다.

| 계절성 | 주기 $P$ | 기본 푸리에 차수 $N$ | 특징 |
|--------|---------|-------------------|------|
| 연간 | 365.25 | 10 | 부드러운 패턴 |
| 주간 | 7 | 3 | 요일 효과 |
| 일간 | 1 | 4 | 시간대별 패턴 |

```python
# 커스텀 계절성 추가
model = Prophet()
model.add_seasonality(name='monthly', period=30.5, fourier_order=5)
model.add_seasonality(name='quarterly', period=91.25, fourier_order=3)
model.fit(df)
```

> **핵심 직관**: 푸리에 차수 $N$이 크면 세밀한 패턴을 포착하지만 과적합 위험이 커지고, 작으면 부드러운 계절성만 표현됩니다.

---

## 4. 휴일 효과와 이벤트

### 4.1 휴일 모델

$$h(t) = \sum_{i=1}^{L} \kappa_i \cdot \mathbf{1}_{[t \in D_i]}$$

여기서 $D_i$는 휴일 $i$의 날짜 집합이고, $\kappa_i$는 그 효과의 크기입니다.

```python
# 한국 공휴일 설정
holidays = pd.DataFrame({
    'holiday': ['설날', '설날', '추석', '추석'],
    'ds': pd.to_datetime(['2023-01-22', '2024-02-10',
                          '2023-09-29', '2024-09-17']),
    'lower_window': -1,  # 전날부터
    'upper_window': 1,   # 다음날까지
})

model = Prophet(holidays=holidays)
model.add_country_holidays(country_name='KR')
model.fit(df)
```

| 설정 | 의미 | 예시 |
|------|------|------|
| `lower_window` | 휴일 이전 효과 범위 | -2: 이틀 전부터 |
| `upper_window` | 휴일 이후 효과 범위 | 1: 다음날까지 |
| `prior_scale` | 효과 크기 정규화 | 클수록 유연 |

> **핵심 직관**: 매출·트래픽 예측에서 휴일 효과를 무시하면 큰 예측 오차가 발생합니다. Prophet은 이를 직접 모델에 반영합니다.

---

## 5. 시계열 교차 검증 (Time Series CV)

### 5.1 왜 일반 CV를 쓸 수 없는가

시계열에서 일반적인 k-fold CV는 **미래 정보 누출(data leakage)**을 일으킵니다.

### 5.2 시계열 CV 방법

**Expanding window** (확장 창):

| Fold | 훈련 기간 | 검증 기간 |
|------|---------|---------|
| 1 | 1 ~ 100 | 101 ~ 130 |
| 2 | 1 ~ 130 | 131 ~ 160 |
| 3 | 1 ~ 160 | 161 ~ 190 |

**Sliding window** (슬라이딩 창):

| Fold | 훈련 기간 | 검증 기간 |
|------|---------|---------|
| 1 | 1 ~ 100 | 101 ~ 130 |
| 2 | 31 ~ 130 | 131 ~ 160 |
| 3 | 61 ~ 160 | 161 ~ 190 |

```python
from prophet.diagnostics import cross_validation, performance_metrics

# Prophet 시계열 CV
cv_results = cross_validation(
    model,
    initial='730 days',    # 초기 훈련 기간
    period='180 days',     # cutoff 간격
    horizon='365 days'     # 예측 수평선
)
metrics = performance_metrics(cv_results)
print(metrics[['horizon', 'mape', 'rmse', 'mae']].tail())
```

> **핵심 직관**: 시계열 CV에서는 반드시 **시간 순서**를 지켜야 합니다. 미래 데이터로 훈련하고 과거를 예측하면 낙관적 편향이 발생합니다.

---

## 6. 예측 성능 평가 지표

| 지표 | 수식 | 특징 |
|------|------|------|
| MAE | $\frac{1}{h}\sum\lvert y_t - \hat{y}_t\rvert$ | 이상치에 덜 민감 |
| RMSE | $\sqrt{\frac{1}{h}\sum(y_t - \hat{y}_t)^2}$ | 큰 오차에 민감 |
| MAPE | $\frac{100}{h}\sum\lvert\frac{y_t - \hat{y}_t}{y_t}\rvert$ | 스케일 무관, 0 근처 불안정 |
| SMAPE | $\frac{200}{h}\sum\frac{\lvert y_t - \hat{y}_t\rvert}{\lvert y_t\rvert + \lvert\hat{y}_t\rvert}$ | 대칭적 |
| MASE | $\frac{\text{MAE}}{\text{naive MAE}}$ | 나이브 대비 상대 성능 |

```python
from prophet.diagnostics import performance_metrics
from prophet.plot import plot_cross_validation_metric

fig = plot_cross_validation_metric(cv_results, metric='mape')
```

> **핵심 직관**: MASE가 1보다 크면 나이브 예측(직전 값 반복)보다 못한 것이며, 모델이 가치를 제공하지 못하는 것입니다.

---

## 7. Prophet의 한계와 대안 도구

### 7.1 한계

| 한계 | 설명 | 대안 |
|------|------|------|
| 외생 변수 | 제한적 지원 | SARIMAX, LightGBM |
| 다변량 | 지원 안 됨 | VAR (ts-07), TFT (ts-10) |
| 불규칙 간격 | 일부 지원 | 가우시안 프로세스 |
| 짧은 시계열 | 성능 저하 | ETS, 단순 방법 |

### 7.2 현대 예측 도구 비교

| 도구 | 접근 | 장점 | 단점 |
|------|------|------|------|
| Prophet | GAM | 직관적, 휴일 효과 | 다변량 불가 |
| NeuralProphet | Prophet + DL | 자기회귀 추가 | 학습 필요 |
| statsforecast | 통계 모델 | 빠름, 대규모 | 유연성 낮음 |
| GluonTS | 딥러닝 | 확률적 예측 | 학습 비용 |
| Darts | 통합 | 다양한 모델 | API 복잡 |

```python
# NeuralProphet 예시
from neuralprophet import NeuralProphet

np_model = NeuralProphet(
    n_lags=30,          # 자기회귀 차수
    n_forecasts=7,      # 다중 수평선
    yearly_seasonality=True,
    weekly_seasonality=True
)
np_model.fit(df, freq='D')
forecast = np_model.predict(df)
```

> **핵심 직관**: Prophet은 "80%의 경우에 빠르고 충분히 좋은" 도구이지만, 복잡한 시나리오에서는 ts-10의 딥러닝 모델이나 도메인 특화 방법이 필요합니다.

---

## 핵심 정리

- **Prophet은 추세(변화점 포함) + 계절성(푸리에 급수) + 휴일 효과를 가법적으로 결합한 GAM 기반 모델입니다.**
- **`changepoint_prior_scale`은 추세 유연성을 조절하는 핵심 하이퍼파라미터이며, 과적합-과소적합을 제어합니다.**
- **계절성은 푸리에 급수로 표현되며, 차수 $N$이 세밀함을 조절하고, 커스텀 계절성을 자유롭게 추가할 수 있습니다.**
- **시계열 교차 검증은 반드시 시간 순서를 유지해야 하며, expanding/sliding window 방식을 사용합니다.**
- **MASE > 1이면 나이브 예측보다 못한 것이므로, 모든 모델은 나이브 기준선과 비교되어야 합니다.**
