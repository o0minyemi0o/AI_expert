# 이상 탐지와 변화점 감지: CUSUM, 베이즈 변화점, 실시간 감지

## 왜 이상 탐지와 변화점 감지가 중요한가

시계열 데이터에서 이상(anomaly)과 변화점(change point)을 감지하는 것은 산업 현장의 핵심 과제입니다. 서버 장애, 금융 사기, 제조 불량, 전염병 확산 등은 모두 시계열의 비정상적 패턴으로 나타납니다. ts-08에서 구조 변화 탐지를 간략히 다루었지만, 이 강의에서는 CUSUM, 베이즈 변화점 탐지, 실시간 감지 방법을 깊이 있게 살펴봅니다.

---

## 1. 이상(Anomaly)과 변화점(Change Point)의 구분

| 구분 | 이상 (Anomaly) | 변화점 (Change Point) |
|------|--------------|---------------------|
| 정의 | 기존 패턴에서 벗어난 개별 관측 | 데이터 생성 과정 자체의 변화 |
| 지속성 | 일시적 | 영구적 (또는 장기적) |
| 예시 | 센서 오작동, 주가 급등 | 정책 변경, 시스템 업그레이드 |
| 영향 | 주변 데이터와 무관 | 이후 모든 데이터에 영향 |

### 이상의 유형

| 유형 | 설명 | 예시 |
|------|------|------|
| 점 이상 (Point) | 단일 값이 비정상 | 센서 스파이크 |
| 맥락 이상 (Contextual) | 특정 맥락에서만 비정상 | 여름에 난방 사용량 급증 |
| 집합 이상 (Collective) | 값의 집합이 비정상 | 서버 응답 패턴 변화 |

> **핵심 직관**: 이상은 "예외적 사건"이고, 변화점은 "규칙 자체의 변화"입니다. 같은 알고리즘이 두 경우 모두에 적용되지만 해석이 다릅니다.

---

## 2. 통계적 이상 탐지 방법

### 2.1 Z-score 기반

$$z_t = \frac{Y_t - \mu}{\sigma}$$

$|z_t| > 3$이면 이상으로 판정합니다.

### 2.2 이동 평균/분산 기반

$$\mu_t = \frac{1}{w} \sum_{i=0}^{w-1} Y_{t-i}, \quad \sigma_t^2 = \frac{1}{w} \sum_{i=0}^{w-1} (Y_{t-i} - \mu_t)^2$$

| 방법 | 장점 | 단점 |
|------|------|------|
| 글로벌 Z-score | 단순 | 비정상 시계열에 부적합 |
| 이동 Z-score | 적응적 | 윈도우 크기 선택 필요 |
| MAD (중앙 절대 편차) | 로버스트 | 분포 가정 |
| IQR 기반 | 비모수적 | 시간 의존성 무시 |

### 2.3 모델 기반 이상 탐지

ts-02의 ARIMA 등으로 예측한 후, 잔차가 임계값을 초과하면 이상으로 판정합니다.

```python
from statsmodels.tsa.arima.model import ARIMA
import numpy as np

model = ARIMA(ts_train, order=(2, 1, 1)).fit()
residuals = model.resid
threshold = 3 * residuals.std()
anomalies = np.abs(residuals) > threshold
print(f"이상 탐지: {anomalies.sum()}개")
```

> **핵심 직관**: 좋은 모델의 잔차는 백색 잡음이어야 하므로(ts-01 참조), 잔차의 비정상적 큰 값은 모델이 설명하지 못한 **이상 사건**입니다.

---

## 3. CUSUM (Cumulative Sum)

### 3.1 기본 CUSUM

프로세스 평균의 이동을 탐지하는 순차 검정입니다.

상향 CUSUM:

$$C_t^+ = \max(0, \, C_{t-1}^+ + (Y_t - \mu_0 - k))$$

하향 CUSUM:

$$C_t^- = \max(0, \, C_{t-1}^- - (Y_t - \mu_0 + k))$$

| 파라미터 | 의미 | 일반적 선택 |
|---------|------|-----------|
| $\mu_0$ | 기준 평균 | 관리 상태 평균 |
| $k$ | 허용 슬랙 (reference value) | $\delta \sigma / 2$ |
| $h$ | 결정 임계값 (decision interval) | $4\sigma$ ~ $5\sigma$ |

알람 조건: $C_t^+ > h$ 또는 $C_t^- > h$

```python
import numpy as np

def cusum(data, target_mean, k, h):
    cusum_pos = np.zeros(len(data))
    cusum_neg = np.zeros(len(data))
    alarms = []
    for t in range(1, len(data)):
        cusum_pos[t] = max(0, cusum_pos[t-1] + data[t] - target_mean - k)
        cusum_neg[t] = max(0, cusum_neg[t-1] - data[t] + target_mean - k)
        if cusum_pos[t] > h or cusum_neg[t] > h:
            alarms.append(t)
    return cusum_pos, cusum_neg, alarms

c_pos, c_neg, alarms = cusum(ts.values, target_mean=0, k=0.5, h=4)
```

> **핵심 직관**: CUSUM은 작은 이동의 **누적 효과**를 추적합니다. 개별 시점에서는 감지 못하는 미세한 평균 이동도 누적되면 탐지됩니다.

---

## 4. 베이지안 변화점 탐지

### 4.1 오프라인 방법: Bayesian Change Point Detection

전체 시계열에서 변화점의 위치와 수를 사후 분포로 추정합니다.

$$P(\tau_1, \ldots, \tau_m \mid \mathbf{Y}) \propto P(\mathbf{Y} \mid \tau_1, \ldots, \tau_m) P(\tau_1, \ldots, \tau_m)$$

| 요소 | 설명 |
|------|------|
| $\tau_k$ | $k$번째 변화점 위치 |
| $P(\mathbf{Y} \mid \boldsymbol{\tau})$ | 세그먼트별 우도 |
| $P(\boldsymbol{\tau})$ | 변화점 사전 분포 |

### 4.2 온라인 방법: BOCPD (Bayesian Online Change Point Detection)

Adams & MacKay (2007)의 방법으로, **실행 길이(run length)** $r_t$의 사후 분포를 온라인으로 갱신합니다.

$$P(r_t \mid Y_{1:t}) \propto \sum_{r_{t-1}} P(Y_t \mid r_{t-1}, Y_{1:t-1}) \cdot P(r_t \mid r_{t-1}) \cdot P(r_{t-1} \mid Y_{1:t-1})$$

| 실행 길이 $r_t$ | 의미 |
|----------------|------|
| $r_t = 0$ | 시점 $t$에서 변화점 발생 |
| $r_t = r_{t-1} + 1$ | 현재 세그먼트 계속 |

```python
# ruptures 라이브러리를 사용한 베이지안 변화점 탐지
import ruptures as rpt

# 오프라인 탐지
signal = ts.values
algo = rpt.Binseg(model="normal").fit(signal)
breakpoints = algo.predict(n_bkps=3)  # 3개 변화점

# 시각화
rpt.display(signal, breakpoints)
```

> **핵심 직관**: 베이지안 변화점 탐지는 변화점의 위치에 대한 **불확실성을 확률로 표현**합니다. "여기가 변화점이다"가 아니라 "여기가 변화점일 확률이 95%이다"라고 말합니다.

---

## 5. 실시간 이상 탐지 시스템

### 5.1 아키텍처

| 단계 | 구성 요소 | 역할 |
|------|---------|------|
| 수집 | Kafka, Kinesis | 실시간 스트리밍 |
| 전처리 | 윈도우 통계 계산 | 특징 추출 |
| 탐지 | CUSUM, BOCPD, ML 모델 | 이상 판정 |
| 알림 | 대시보드, Slack, PagerDuty | 운영자 통보 |

### 5.2 실시간 방법 비교

| 방법 | 지연 시간 | 적응성 | 복잡도 |
|------|---------|-------|-------|
| 고정 임계값 | 즉시 | 없음 | 매우 낮음 |
| CUSUM | 낮음 | 낮음 | 낮음 |
| EWMA 관리도 | 낮음 | 중간 | 낮음 |
| BOCPD | 중간 | 높음 | 중간 |
| Isolation Forest | 중간 | 중간 | 중간 |
| LSTM Autoencoder | 높음 | 높음 | 높음 |

### 5.3 EWMA 관리도

ts-04에서 배운 지수 평활의 원리를 이상 탐지에 적용합니다.

$$Z_t = \lambda Y_t + (1 - \lambda) Z_{t-1}$$

관리 한계:

$$\mu_0 \pm L \cdot \sigma \sqrt{\frac{\lambda}{2 - \lambda}\left[1 - (1-\lambda)^{2t}\right]}$$

```python
def ewma_control(data, lambda_param=0.2, L=3):
    n = len(data)
    mu0 = np.mean(data[:50])  # 기준 평균
    sigma = np.std(data[:50])
    z = np.zeros(n)
    z[0] = mu0
    ucl = np.zeros(n)
    lcl = np.zeros(n)
    for t in range(1, n):
        z[t] = lambda_param * data[t] + (1 - lambda_param) * z[t-1]
        se = sigma * np.sqrt(lambda_param / (2 - lambda_param) * (1 - (1-lambda_param)**(2*t)))
        ucl[t] = mu0 + L * se
        lcl[t] = mu0 - L * se
    return z, ucl, lcl
```

> **핵심 직관**: EWMA 관리도는 작은 이동을 빠르게 감지하며, $\lambda$가 작을수록 과거를 더 많이 기억하여 미세한 변화를 잡아냅니다.

---

## 6. 머신러닝 기반 이상 탐지

### 6.1 Isolation Forest

정상 데이터보다 이상 데이터가 더 빨리 "고립"된다는 원리입니다.

$$s(x, n) = 2^{-\frac{E[h(x)]}{c(n)}}$$

여기서 $h(x)$는 고립 경로 길이, $c(n)$은 정규화 상수입니다.

### 6.2 LSTM Autoencoder

정상 패턴을 학습한 후, 재구성 오차가 큰 구간을 이상으로 판정합니다.

$$\text{anomaly score}_t = \| \mathbf{x}_t - \hat{\mathbf{x}}_t \|^2$$

```python
import torch.nn as nn

class LSTMAutoencoder(nn.Module):
    def __init__(self, input_dim, hidden_dim, seq_len):
        super().__init__()
        self.encoder = nn.LSTM(input_dim, hidden_dim, batch_first=True)
        self.decoder = nn.LSTM(hidden_dim, input_dim, batch_first=True)
        self.seq_len = seq_len

    def forward(self, x):
        _, (h, c) = self.encoder(x)
        # 디코더 입력: 인코더의 마지막 은닉 상태 반복
        decoder_input = h.squeeze(0).unsqueeze(1).repeat(1, self.seq_len, 1)
        output, _ = self.decoder(decoder_input)
        return output
```

| 방법 | 비지도 | 시간 의존성 | 설명 가능성 |
|------|-------|-----------|-----------|
| Isolation Forest | O | X | 중간 |
| LSTM Autoencoder | O | O | 낮음 |
| Prophet 잔차 | O | O | 높음 |
| One-Class SVM | O | X | 낮음 |

> **핵심 직관**: 정상 패턴만 학습하고, 이에서 벗어나는 것을 이상으로 판정하는 것이 **비지도 이상 탐지**의 핵심 원리입니다.

---

## 7. 평가 지표와 실무 고려사항

### 7.1 평가 지표

| 지표 | 수식 | 이상 탐지에서의 의미 |
|------|------|-------------------|
| 정밀도 | $\frac{TP}{TP+FP}$ | 알람 중 실제 이상 비율 |
| 재현율 | $\frac{TP}{TP+FN}$ | 실제 이상 중 탐지된 비율 |
| F1 | $\frac{2 \cdot P \cdot R}{P + R}$ | 정밀도-재현율 균형 |
| AUC-PR | PR 곡선 아래 면적 | 불균형 데이터에 적합 |

### 7.2 실무 고려사항

| 고려사항 | 설명 |
|---------|------|
| 불균형 | 이상은 전체의 0.1~1%로 극히 드묾 |
| 알람 피로 | 거짓 양성이 많으면 운영자가 무시 |
| 지연 허용 | 감지 지연 vs. 오탐률 트레이드오프 |
| 계절 보정 | 계절 패턴을 정상으로 인식해야 함 |

> **핵심 직관**: 이상 탐지에서 가장 큰 실무적 과제는 **알람 피로**입니다. 정밀도가 낮으면 운영자가 모든 알람을 무시하게 되어, 진짜 이상도 놓치게 됩니다.

---

## 핵심 정리

- **이상은 일시적 이탈이고 변화점은 영구적 구조 변화이며, 두 개념은 구분되지만 유사한 방법으로 탐지됩니다.**
- **CUSUM은 작은 평균 이동의 누적 효과를 추적하여, 개별 시점에서는 감지 못하는 미세한 변화를 탐지합니다.**
- **베이지안 변화점 탐지(BOCPD)는 변화점 위치의 불확실성을 확률로 표현하여, 온라인 실시간 감지가 가능합니다.**
- **LSTM Autoencoder는 정상 패턴을 학습하고 재구성 오차로 이상을 판정하는 비지도 딥러닝 방법입니다.**
- **실무에서는 알람 피로를 방지하기 위해 정밀도와 재현율의 균형을 조정하고, 계절성 보정이 필수입니다.**
