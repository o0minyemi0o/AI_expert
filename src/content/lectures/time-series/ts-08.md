# 비정상성과 구조 변화: ADF 검정, 공적분, 구조 변화 탐지

## 왜 비정상성과 구조 변화를 다루는가

실세계 시계열은 대부분 비정상(non-stationary)입니다. 주가는 추세를 가지고, 경제 지표는 정책 변화에 의해 구조가 바뀌며, 기후 데이터는 장기적 수준 이동을 보입니다. ts-01에서 정상성의 중요성을 배웠지만, 비정상성을 **어떻게 검정하고**, 공적분으로 **의미 있는 관계를 발견하며**, 구조 변화를 **어떻게 탐지하는지**를 이 강의에서 체계적으로 다룹니다.

---

## 1. 단위근 (Unit Root)과 비정상성

### 1.1 단위근 과정

AR(1) 모델 $Y_t = \phi Y_{t-1} + \epsilon_t$에서 $\phi = 1$이면 **랜덤 워크**가 됩니다.

$$Y_t = Y_{t-1} + \epsilon_t \implies Y_t = Y_0 + \sum_{i=1}^{t} \epsilon_i$$

| 구분 | $\lvert\phi\rvert < 1$ | $\phi = 1$ | $\lvert\phi\rvert > 1$ |
|------|---------------------|-----------|---------------------|
| 이름 | 정상 AR(1) | 랜덤 워크 | 폭발 과정 |
| 평균 회귀 | O | X | X |
| 분산 | $\sigma^2/(1-\phi^2)$ | $t\sigma^2$ (발산) | 발산 |
| 충격 효과 | 감쇠 | 영구적 | 증폭 |

> **핵심 직관**: 단위근이 있으면 충격의 효과가 **영구적**으로 남습니다. 정상 시계열에서는 충격이 시간이 지나면 사라집니다.

---

## 2. ADF 검정 (Augmented Dickey-Fuller Test)

### 2.1 Dickey-Fuller 검정

$$\Delta Y_t = \alpha + \delta t + \gamma Y_{t-1} + \epsilon_t$$

$$H_0: \gamma = 0 \quad (\text{단위근 존재, 비정상})$$

$$H_1: \gamma < 0 \quad (\text{단위근 없음, 정상})$$

### 2.2 ADF 검정

자기상관을 제거하기 위해 시차 차분을 추가합니다.

$$\Delta Y_t = \alpha + \delta t + \gamma Y_{t-1} + \sum_{j=1}^{k} \beta_j \Delta Y_{t-j} + \epsilon_t$$

| 모형 | 포함 항목 | 사용 상황 |
|------|---------|---------|
| 모형 1 | 없음 | 평균이 0인 시계열 |
| 모형 2 | 상수 $\alpha$ | 평균이 0이 아닌 시계열 |
| 모형 3 | 상수 + 추세 $\delta t$ | 결정적 추세가 있는 시계열 |

```python
from statsmodels.tsa.stattools import adfuller

result = adfuller(ts, maxlag=None, autolag='AIC', regression='ct')
print(f'ADF 통계량: {result[0]:.4f}')
print(f'p-value: {result[1]:.4f}')
print(f'사용된 시차: {result[2]}')
print(f'임계값: {result[4]}')
```

> **핵심 직관**: ADF 검정의 p-value가 0.05 이상이면 단위근을 기각할 수 없으며, 차분이 필요합니다. ts-03에서 배운 차분 전에 반드시 수행합니다.

---

## 3. 다른 단위근 검정

### 3.1 KPSS 검정

ADF와 **반대** 가설 구조를 가집니다.

$$H_0: \text{정상} \quad vs. \quad H_1: \text{비정상}$$

### 3.2 Phillips-Perron 검정

비모수적 방법으로 자기상관을 처리합니다.

| 검정 | 귀무가설 | 특징 | 추천 사용법 |
|------|---------|------|-----------|
| ADF | 비정상 | 시차 추가 | 기본 검정 |
| KPSS | 정상 | 비모수적 | ADF와 함께 |
| PP | 비정상 | 비모수적 | ADF 보완 |

### 3.3 확인 전략

| ADF 결과 | KPSS 결과 | 해석 |
|---------|----------|------|
| 기각 | 기각 안 됨 | 정상 (일관된 결론) |
| 기각 안 됨 | 기각 | 비정상 (일관된 결론) |
| 기각 | 기각 | 추세 정상 가능 |
| 기각 안 됨 | 기각 안 됨 | 검정력 부족, 데이터 추가 |

```python
from statsmodels.tsa.stattools import kpss

stat, p_value, lags, crit = kpss(ts, regression='ct')
print(f'KPSS 통계량: {stat:.4f}, p-value: {p_value:.4f}')
```

> **핵심 직관**: ADF와 KPSS를 함께 사용하면, 단위근 존재 여부에 대한 **더 신뢰할 수 있는 결론**을 얻을 수 있습니다.

---

## 4. 공적분 (Cointegration)

### 4.1 개념

개별적으로 비정상인 시계열들이 특정 선형 결합에서 정상이 되는 관계입니다.

$$Y_{1t} \sim I(1), \quad Y_{2t} \sim I(1)$$

$$Y_{1t} - \beta Y_{2t} = u_t \sim I(0)$$

이 경우 $Y_1$과 $Y_2$는 **공적분**되어 있다고 합니다.

### 4.2 경제적 해석

| 예시 | $Y_1$ | $Y_2$ | 해석 |
|------|-------|-------|------|
| 구매력 평가 | 환율 | 물가 차이 | 장기 균형 |
| 현물-선물 | 현물 가격 | 선물 가격 | 차익거래 관계 |
| 쌍거래 | 주식 A 가격 | 주식 B 가격 | 스프레드 회귀 |

> **핵심 직관**: 공적분은 "각각은 방황하지만, 함께는 장기 균형을 유지한다"는 관계입니다. 취한 친구 둘이 서로 잡고 걷는 것에 비유할 수 있습니다.

---

## 5. 공적분 검정

### 5.1 Engle-Granger 2단계 검정

1. OLS로 공적분 회귀: $Y_{1t} = \alpha + \beta Y_{2t} + u_t$
2. 잔차 $\hat{u}_t$에 ADF 검정

```python
from statsmodels.tsa.stattools import coint

# Engle-Granger 공적분 검정
score, p_value, crit_values = coint(y1, y2)
print(f'공적분 검정 통계량: {score:.4f}, p-value: {p_value:.4f}')
```

### 5.2 Johansen 검정

$K$개 변수 간 공적분 관계의 **수**를 검정합니다.

$$H_0: r \leq r_0 \quad (\text{공적분 벡터가 } r_0 \text{개 이하})$$

| 방법 | 변수 수 | 공적분 벡터 수 | 장점 |
|------|--------|-------------|------|
| Engle-Granger | 2개 | 1개 | 단순 |
| Johansen (Trace) | K개 | 0 ~ K-1개 | 다변량, 체계적 |
| Johansen (Max-Eigen) | K개 | 순차 검정 | 개별 판별 |

```python
from statsmodels.tsa.vector_ar.vecm import coint_johansen

johansen_result = coint_johansen(data, det_order=0, k_ar_diff=2)
print('Trace 통계량:', johansen_result.lr1)
print('임계값 (95%):', johansen_result.cvt[:, 1])
```

> **핵심 직관**: Engle-Granger는 2변수 공적분에, Johansen은 **다변량 공적분**에 사용합니다.

---

## 6. 벡터 오차 수정 모델 (VECM)

공적분 관계가 존재할 때, VAR 대신 VECM을 사용합니다.

$$\Delta \mathbf{Y}_t = \boldsymbol{\alpha} \boldsymbol{\beta}^\top \mathbf{Y}_{t-1} + \sum_{i=1}^{p-1} \boldsymbol{\Gamma}_i \Delta \mathbf{Y}_{t-i} + \mathbf{u}_t$$

| 요소 | 의미 |
|------|------|
| $\boldsymbol{\beta}^\top \mathbf{Y}_{t-1}$ | 오차 수정 항 (장기 균형으로부터의 이탈) |
| $\boldsymbol{\alpha}$ | 조정 속도 (균형 복원 속도) |
| $\boldsymbol{\Gamma}_i$ | 단기 동학 |

```python
from statsmodels.tsa.vector_ar.vecm import VECM

vecm = VECM(data, k_ar_diff=2, coint_rank=1)
vecm_result = vecm.fit()
print(vecm_result.summary())
```

> **핵심 직관**: VECM은 "단기 변동"과 "장기 균형 복원"을 분리하여, 공적분 관계를 ts-07의 VAR보다 더 정확하게 모델링합니다.

---

## 7. 구조 변화 탐지

### 7.1 Chow 검정

알려진 변화점 $t^*$에서 구조 변화를 검정합니다.

$$H_0: \text{전체 기간에 동일 계수} \quad vs. \quad H_1: t^* \text{에서 계수 변화}$$

### 7.2 CUSUM 검정

순차적 잔차의 누적합으로 구조 안정성을 검정합니다.

$$W_t = \frac{1}{\hat{\sigma}} \sum_{j=k+1}^{t} \hat{v}_j$$

### 7.3 Bai-Perron 검정

변화점의 위치와 수를 동시에 추정합니다.

| 방법 | 변화점 가정 | 변화점 수 | 적합 상황 |
|------|-----------|---------|---------|
| Chow | 알려짐 | 1개 | 이론적 근거 있음 |
| CUSUM | 알려지지 않음 | 탐지 | 실시간 모니터링 |
| Bai-Perron | 알려지지 않음 | 다수 가능 | 다중 변화점 |

```python
import ruptures as rpt

# Bai-Perron 스타일 변화점 탐지
signal = ts.values
algo = rpt.Pelt(model="rbf").fit(signal)
breakpoints = algo.predict(pen=10)
print(f"변화점: {breakpoints}")

# 시각화
rpt.display(signal, breakpoints)
```

> **핵심 직관**: 구조 변화를 무시하면 모델 파라미터가 "평균"되어 어떤 시기에도 맞지 않는 모델이 됩니다. ts-11에서 변화점 감지를 더 깊이 다룹니다.

---

## 핵심 정리

- **단위근은 충격의 효과가 영구적으로 남는 비정상성의 원인이며, ADF 검정으로 존재 여부를 확인합니다.**
- **ADF와 KPSS를 함께 사용하면 정상성/비정상성에 대한 더 신뢰할 수 있는 결론을 얻습니다.**
- **공적분은 개별적으로 비정상인 시계열들이 선형 결합에서 정상이 되는 장기 균형 관계입니다.**
- **VECM은 공적분 관계가 있을 때 VAR 대신 사용하며, 장기 균형 복원과 단기 동학을 분리합니다.**
- **구조 변화가 있으면 전체 기간에 하나의 모델을 적합하는 것이 부적절하며, Bai-Perron 등으로 변화점을 탐지합니다.**
