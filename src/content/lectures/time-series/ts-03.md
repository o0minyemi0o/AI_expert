# ARIMA와 계절 모델: 차분, ARIMA(p,d,q), SARIMA, Box-Jenkins

## 왜 ARIMA와 계절 모델이 필요한가

현실의 시계열은 대부분 비정상(non-stationary)이며, 추세와 계절 패턴을 동시에 포함합니다. ts-02에서 다룬 ARMA 모델은 정상 시계열만 다룰 수 있으므로, 차분(differencing)을 통해 비정상성을 제거한 뒤 ARMA를 적용하는 ARIMA 모델이 필요합니다. 여기에 계절성을 추가한 SARIMA와 체계적 모델링 절차인 Box-Jenkins 방법론을 함께 다룹니다.

---

## 1. 차분 (Differencing)

차분은 비정상 시계열을 정상 시계열로 변환하는 가장 기본적인 방법입니다.

### 1.1 일반 차분

$$\nabla Y_t = Y_t - Y_{t-1} = (1 - B) Y_t$$

$d$차 차분:

$$\nabla^d Y_t = (1 - B)^d Y_t$$

### 1.2 계절 차분

주기 $s$를 가진 계절성 제거:

$$\nabla_s Y_t = Y_t - Y_{t-s} = (1 - B^s) Y_t$$

| 차분 유형 | 연산 | 제거하는 성분 | 예시 |
|----------|------|------------|------|
| 1차 차분 | $Y_t - Y_{t-1}$ | 선형 추세 | 주가 → 수익률 |
| 2차 차분 | $\nabla^2 Y_t$ | 2차 추세 | 가속하는 추세 |
| 계절 차분 ($s=12$) | $Y_t - Y_{t-12}$ | 연간 계절성 | 월별 전력 수요 |

> **핵심 직관**: 차분은 "변화량"을 계산하여 수준(level)의 비정상성을 제거합니다. 주가를 수익률로 바꾸는 것이 1차 차분입니다.

```python
import pandas as pd
import numpy as np

# 1차 차분
y_diff = ts.diff().dropna()

# 계절 차분 (월별 데이터, s=12)
y_seasonal_diff = ts.diff(12).dropna()
```

---

## 2. ARIMA(p, d, q) 모델

ARIMA는 $d$차 차분 후 ARMA(p, q)를 적용한 모델입니다.

$$\Phi(B)(1 - B)^d Y_t = c + \Theta(B) \epsilon_t$$

| 파라미터 | 의미 | 결정 방법 |
|---------|------|---------|
| $p$ | AR 차수 | PACF 절단점 |
| $d$ | 차분 횟수 | ADF 검정 (ts-08 참조) |
| $q$ | MA 차수 | ACF 절단점 |

### 특수한 경우

| 모델 | ARIMA 표현 | 설명 |
|------|-----------|------|
| 백색 잡음 | ARIMA(0,0,0) | 독립 동일 분포 |
| 랜덤 워크 | ARIMA(0,1,0) | $Y_t = Y_{t-1} + \epsilon_t$ |
| 랜덤 워크 + 드리프트 | ARIMA(0,1,0) + c | $Y_t = c + Y_{t-1} + \epsilon_t$ |
| AR(1) | ARIMA(1,0,0) | 정상 자기회귀 |

> **핵심 직관**: ARIMA는 "차분으로 정상화한 뒤 ARMA를 적용"하는 모델입니다. $d$가 핵심이며, 보통 $d \leq 2$이면 충분합니다.

```python
from statsmodels.tsa.arima.model import ARIMA

# ARIMA(1,1,1) 적합
model = ARIMA(ts, order=(1, 1, 1))
result = model.fit()
print(result.summary())
```

---

## 3. SARIMA — 계절 ARIMA

SARIMA는 비계절 성분과 계절 성분을 동시에 모델링합니다.

$$\Phi(B)\,\Phi_s(B^s)\,(1-B)^d\,(1-B^s)^D\,Y_t = c + \Theta(B)\,\Theta_s(B^s)\,\epsilon_t$$

SARIMA$(p, d, q) \times (P, D, Q)_s$로 표기합니다.

| 파라미터 | 비계절 | 계절 |
|---------|--------|------|
| AR 차수 | $p$ | $P$ |
| 차분 차수 | $d$ | $D$ |
| MA 차수 | $q$ | $Q$ |
| 주기 | — | $s$ |

### 실용적 가이드라인

| 데이터 주기 | $s$ 값 | 일반적 초기 모델 |
|-----------|--------|--------------|
| 월별 | 12 | $(1,1,1) \times (1,1,1)_{12}$ |
| 분기별 | 4 | $(1,1,1) \times (1,1,1)_4$ |
| 주별 | 52 | 파라미터 과다 — Prophet 권장 |
| 일별 (주단위 계절) | 7 | $(1,1,1) \times (1,1,1)_7$ |

> **핵심 직관**: SARIMA는 "단기 패턴(ARIMA)"과 "계절 패턴(계절 ARIMA)"을 곱셈적으로 결합합니다.

```python
from statsmodels.tsa.statespace.sarimax import SARIMAX

# SARIMA(1,1,1)(1,1,1,12) 적합
model = SARIMAX(ts_monthly,
                order=(1, 1, 1),
                seasonal_order=(1, 1, 1, 12),
                enforce_stationarity=False)
result = model.fit(disp=False)
print(result.summary())
```

월별 항공 승객 데이터에 SARIMA$(0,1,1)(0,1,1)_{12}$가 잘 맞는 것으로 알려져 있습니다.

---

## 4. Box-Jenkins 방법론

Box와 Jenkins가 제안한 체계적인 ARIMA 모델링 절차입니다.

### 4단계 절차

| 단계 | 작업 | 도구 |
|------|------|------|
| **식별** | 차수 $(p, d, q)$ 결정 | ACF/PACF, ADF 검정 |
| **추정** | 파라미터 $\phi, \theta$ 추정 | MLE (si-02 참조) |
| **진단** | 잔차 검정 | Ljung-Box (ts-01 참조), QQ-플롯 |
| **예측** | 미래 값 예측 | 점 예측 + 신뢰 구간 |

```python
# Box-Jenkins 전체 워크플로우
from statsmodels.tsa.stattools import adfuller

# 1. 식별: 정상성 검정
adf_result = adfuller(ts)
print(f'ADF 통계량: {adf_result[0]:.4f}, p-value: {adf_result[1]:.4f}')

# 2. 추정
model = ARIMA(ts, order=(1, 1, 1))
result = model.fit()

# 3. 진단
from statsmodels.stats.diagnostic import acorr_ljungbox
lb_test = acorr_ljungbox(result.resid, lags=10, return_df=True)
print(lb_test)

# 4. 예측
forecast = result.forecast(steps=12)
```

> **핵심 직관**: Box-Jenkins는 "식별 → 추정 → 진단 → 예측"의 **반복적** 과정입니다. 진단에서 문제가 발견되면 식별 단계로 돌아갑니다.

---

## 5. 자동 ARIMA와 실무 팁

### 5.1 auto_arima

`pmdarima` 라이브러리의 `auto_arima`는 AIC/BIC를 기준으로 최적 차수를 자동 탐색합니다.

```python
import pmdarima as pm

auto_model = pm.auto_arima(
    ts,
    seasonal=True, m=12,
    stepwise=True,
    suppress_warnings=True,
    information_criterion='aic',
    trace=True
)
print(auto_model.summary())
```

### 5.2 과차분(Over-differencing) 주의

| 현상 | 원인 | 해결 |
|------|------|------|
| ACF 첫 시차 강한 음의 값 | 과차분 | $d$ 줄이기 |
| 분산 증가 | 불필요한 차분 | 차분 전후 분산 비교 |
| 단위근 상쇄 | $d$와 MA 중복 | 모델 재식별 |

> **핵심 직관**: 차분은 필요한 만큼만 해야 합니다. 과차분은 불필요한 복잡성을 추가하고 예측 성능을 떨어뜨립니다.

---

## 6. 예측과 신뢰 구간

ARIMA의 $h$-단계 앞 예측 오차 분산은 $h$가 커질수록 증가합니다.

$$\text{Var}(e_{T+h}) = \sigma^2 \sum_{j=0}^{h-1} \psi_j^2$$

95% 예측 구간:

$$\hat{Y}_{T+h} \pm 1.96 \, \sigma \sqrt{\sum_{j=0}^{h-1} \psi_j^2}$$

```python
# 예측과 신뢰 구간
forecast_result = result.get_forecast(steps=24)
mean_forecast = forecast_result.predicted_mean
ci = forecast_result.conf_int(alpha=0.05)

import matplotlib.pyplot as plt
plt.figure(figsize=(10, 4))
plt.plot(ts[-100:], label='실측')
plt.plot(mean_forecast, label='예측', color='red')
plt.fill_between(ci.index, ci.iloc[:, 0], ci.iloc[:, 1], alpha=0.2)
plt.legend()
plt.title('ARIMA 예측과 95% 신뢰 구간')
```

> **핵심 직관**: 예측 구간은 시간이 지남에 따라 넓어지며, 이는 **장기 예측의 본질적 한계**를 반영합니다.

---

## 핵심 정리

- **차분은 비정상 시계열을 정상화하는 핵심 변환이며, 일반 차분은 추세를, 계절 차분은 계절성을 제거합니다.**
- **ARIMA(p,d,q)는 $d$차 차분 후 ARMA(p,q)를 적용하는 모델로, 비정상 시계열을 다룰 수 있습니다.**
- **SARIMA는 비계절 ARIMA와 계절 ARIMA를 곱셈적으로 결합하여 계절 패턴을 모델링합니다.**
- **Box-Jenkins 방법론은 식별·추정·진단·예측의 반복 과정으로, 시계열 모델링의 표준 절차입니다.**
- **예측 구간은 예측 수평선이 길어질수록 넓어지며, 과차분은 피해야 합니다.**
