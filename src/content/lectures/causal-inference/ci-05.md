# 잠재 결과 프레임워크

## 왜 잠재 결과를 정의해야 하는가

ci-02~ci-04에서 Pearl의 SCM과 DAG 기반 접근법을 배웠습니다. Donald Rubin이 체계화한 잠재 결과(Potential Outcomes) 프레임워크는 동일한 인과적 질문에 대해 다른 각도에서 접근합니다. "만약 이 개인이 치료를 받았더라면 결과가 어떠했을까?"라는 반사실 질문을 확률 변수로 직접 정의하여, 인과 효과의 추정과 식별 조건을 명확히 합니다.

---

## 1. 잠재 결과의 정의

각 개체 $i$에 대해 치료($T=1$)를 받았을 때의 결과 $Y_i(1)$과 받지 않았을 때의 결과 $Y_i(0)$을 **동시에** 정의합니다.

$$
Y_i = T_i \cdot Y_i(1) + (1 - T_i) \cdot Y_i(0)
$$

| 기호 | 의미 | 관측 여부 |
|------|------|----------|
| $Y_i(1)$ | 개체 $i$가 치료받았을 때의 잠재 결과 | $T_i=1$이면 관측 |
| $Y_i(0)$ | 개체 $i$가 치료받지 않았을 때의 잠재 결과 | $T_i=0$이면 관측 |
| $\tau_i = Y_i(1) - Y_i(0)$ | 개체 수준 인과 효과 | **관측 불가** |

> **핵심 직관**: 한 개인은 치료를 받거나 받지 않거나 둘 중 하나만 경험하므로, $Y_i(1)$과 $Y_i(0)$을 동시에 관측할 수 없습니다. 이것이 인과 추론의 근본 문제(Fundamental Problem of Causal Inference)입니다.

```python
import numpy as np

# 잠재 결과 시뮬레이션 (신이 모든 것을 아는 관점)
np.random.seed(42)
n = 1000

# 진정한 잠재 결과 (현실에서는 관측 불가)
Y0 = np.random.normal(5, 2, n)          # 치료 안 받았을 때
tau = np.random.normal(2, 1, n)          # 개인별 인과 효과
Y1 = Y0 + tau                            # 치료 받았을 때

# 관측되는 것: 한쪽만
T = np.random.binomial(1, 0.5, n)        # 무작위 배정
Y_obs = T * Y1 + (1 - T) * Y0            # 관측 결과

print(f"진정한 ATE: {tau.mean():.3f}")
print(f"관측 기반 추정: {Y_obs[T==1].mean() - Y_obs[T==0].mean():.3f}")
```

---

## 2. SUTVA (안정적 단위 치료 값 가정)

Stable Unit Treatment Value Assumption(SUTVA)은 잠재 결과 프레임워크의 핵심 가정입니다. 이 가정이 없으면 잠재 결과 자체가 잘 정의되지 않습니다.

$$
\text{SUTVA} = \text{간섭 없음(No Interference)} + \text{치료 일관성(Consistency)}
$$

| SUTVA 구성 요소 | 수학적 표현 | 위반 예시 |
|---------------|------------|----------|
| 간섭 없음 | $Y_i(t)$는 $i$ 자신의 치료에만 의존 | 백신 접종의 집단 면역 효과 |
| 치료 일관성 | 같은 치료 수준 → 같은 잠재 결과 | 약 복용량 차이, 수술 숙련도 차이 |
| 관측 일관성 | $T_i = t \Rightarrow Y_i = Y_i(t)$ | 측정 방법에 따른 결과 차이 |

> **핵심 직관**: SUTVA가 위반되면 $Y_i(1)$이 하나의 값으로 정의되지 않습니다. 소셜 네트워크 실험에서 친구의 치료가 나의 결과에 영향을 미치면 간섭이 발생합니다.

---

## 3. 평균 처치 효과: ATE, ATT, CATE

개인 수준의 인과 효과 $\tau_i$는 관측 불가능하므로, 집단 수준의 평균 효과를 추정합니다.

$$
\text{ATE} = E[Y(1) - Y(0)] = E[Y(1)] - E[Y(0)]
$$
$$
\text{ATT} = E[Y(1) - Y(0) \mid T=1]
$$
$$
\text{CATE}(x) = E[Y(1) - Y(0) \mid X=x]
$$

| 추정량 | 정의 | 대상 집단 | 사용 상황 |
|--------|------|----------|----------|
| ATE | 전체 모집단의 평균 효과 | 전체 | 보편적 정책 효과 |
| ATT | 치료군의 평균 효과 | 치료받은 사람 | 기존 치료 평가 |
| ATC | 대조군의 평균 효과 | 치료받지 않은 사람 | 확대 적용 효과 |
| CATE | 하위 그룹별 평균 효과 | 특성 $X=x$인 집단 | ci-10의 이질적 효과 |

> **핵심 직관**: ATE와 ATT는 일반적으로 다릅니다. 약의 부작용이 심한 사람은 약을 안 먹으므로, 약을 먹은 사람들의 효과(ATT)는 전체 효과(ATE)와 다를 수 있습니다.

```python
import numpy as np

# ATE vs ATT 차이 시뮬레이션
np.random.seed(42)
n = 5000

X = np.random.normal(0, 1, n)  # 개인 특성
Y0 = 2 + 0.5 * X + np.random.normal(0, 1, n)
tau = 3 - 1.0 * X               # 효과가 X에 따라 다름 (이질적)
Y1 = Y0 + tau

# 선택 편향: X가 큰 사람이 치료 선택 (효과가 작은 사람)
T = (0.5 * X + np.random.normal(0, 1, n) > 0).astype(int)
Y_obs = T * Y1 + (1 - T) * Y0

true_ate = tau.mean()
true_att = tau[T==1].mean()
naive_est = Y_obs[T==1].mean() - Y_obs[T==0].mean()

print(f"진정한 ATE: {true_ate:.3f}")
print(f"진정한 ATT: {true_att:.3f}")
print(f"Naive 추정 (편향): {naive_est:.3f}")
```

---

## 4. 식별 조건: 무교란성, 양성성, 일관성

관측 데이터에서 인과 효과를 식별하기 위한 세 가지 핵심 가정입니다. 이 가정들이 ci-03의 백도어 기준과 대응됩니다.

$$
\textbf{무교란성 (Unconfoundedness):} \quad (Y(0), Y(1)) \perp\!\!\!\perp T \mid X
$$
$$
\textbf{양성성 (Positivity):} \quad 0 < P(T=1 \mid X=x) < 1 \quad \forall x
$$
$$
\textbf{일관성 (Consistency):} \quad T=t \Rightarrow Y = Y(t)
$$

| 가정 | 의미 | 위반 시 결과 | 검증 가능성 |
|------|------|------------|-----------|
| 무교란성 | X 조건부로 치료 배정이 랜덤 | 편향된 추정 | 검증 불가 (도메인 지식) |
| 양성성 | 모든 X 값에서 치료/비치료 모두 가능 | 외삽 필요, 분산 폭발 | 데이터로 부분적 검증 |
| 일관성 | 관측 결과 = 잠재 결과 | 잠재 결과 비정의 | SUTVA와 동일 |

> **핵심 직관**: 무교란성은 "관측된 공변량 X를 조건화하면 RCT와 같다"는 매우 강한 가정입니다. ci-03의 백도어 기준이 만족되면 무교란성도 만족됩니다.

```python
import numpy as np

# 양성성 위반 검사
np.random.seed(42)
n = 5000
X = np.random.normal(0, 1, n)
propensity = 1 / (1 + np.exp(-2 * X))  # 극단적 경향 점수
T = np.random.binomial(1, propensity, n)

# 양성성 위반 확인
extreme = (propensity < 0.05) | (propensity > 0.95)
print(f"양성성 위반 비율: {extreme.mean():.1%}")
print(f"경향 점수 범위: [{propensity.min():.4f}, {propensity.max():.4f}]")
print("ci-06에서 경향 점수 트리밍으로 양성성 위반을 처리하는 방법을 다룹니다")
```

---

## 5. 무작위 배정의 역할

무작위 배정(Randomization)은 무교란성을 자동으로 만족시키는 유일한 방법입니다. 이것이 RCT가 인과 추론의 gold standard인 이유입니다.

$$
\text{무작위 배정}: \quad T \perp\!\!\!\perp (Y(0), Y(1))
$$
$$
\Rightarrow E[Y(1) - Y(0)] = E[Y \mid T=1] - E[Y \mid T=0]
$$

| 비교 | RCT | 관측 연구 |
|------|-----|---------|
| 무교란성 | 설계로 보장 | 가정 필요 |
| ATE 추정 | 단순 평균 차이 | 조정/매칭 필요 |
| 내적 타당성 | 높음 | 가정에 의존 |
| 외적 타당성 | 연구 대상에 한정 | 더 넓은 모집단 가능 |
| 윤리적 제약 | 있음 (흡연 RCT 불가) | 없음 |

> **핵심 직관**: 무작위 배정이 불가능한 상황(윤리적, 실용적 이유)에서 관측 데이터로부터 인과 효과를 추정하는 것이 인과 추론의 핵심 과제입니다. ci-06~ci-08이 이를 위한 구체적 방법론입니다.

---

## 6. Pearl과 Rubin 프레임워크의 연결

두 프레임워크는 수학적으로 동치이며, 각각 고유한 장점이 있습니다.

$$
\text{Pearl}: \quad P(Y \mid do(X=x)) \quad \longleftrightarrow \quad \text{Rubin}: \quad E[Y(x)]
$$

| 비교 | Pearl (SCM/DAG) | Rubin (잠재 결과) |
|------|----------------|-----------------|
| 표현 | 그래프 (DAG) | 잠재 결과 테이블 |
| 강점 | 식별 전략 도출 | 추정량 설계 |
| 약점 | DAG 사전 지식 필요 | 그래프 없이 통제 변수 선택 어려움 |
| 반사실 | $Y_x(u)$ | $Y_i(x)$ |
| 교란 통제 | 백도어 기준 | 무교란성 가정 |
| 주 사용 분야 | 역학, AI | 통계학, 경제학 |

> **핵심 직관**: 실무에서는 Pearl의 DAG로 인과 구조를 모델링하고 식별 전략을 도출한 뒤, Rubin의 잠재 결과 프레임워크로 추정량을 설계하는 **하이브리드 접근**이 효과적입니다.

```python
import numpy as np

# 두 프레임워크의 동치성: 조정 공식 = 무교란성 하 추정
np.random.seed(42)
n = 50000

Z = np.random.binomial(1, 0.5, n)
T = np.random.binomial(1, 0.3 + 0.4 * Z, n)
Y0 = 1 + 2 * Z + np.random.normal(0, 0.5, n)
Y1 = Y0 + 0.5  # 균일한 인과 효과 = 0.5
Y = T * Y1 + (1 - T) * Y0

# Pearl: 조정 공식
pearl_ate = 0
for z in [0, 1]:
    e1 = Y[(T==1) & (Z==z)].mean()
    e0 = Y[(T==0) & (Z==z)].mean()
    pearl_ate += (e1 - e0) * (Z==z).mean()

# Rubin: IPW (ci-06에서 상세히 다룸)
ps = 0.3 + 0.4 * Z  # 진정한 경향 점수
ipw_ate = (T * Y / ps).mean() - ((1-T) * Y / (1-ps)).mean()

print(f"Pearl 조정 공식 ATE: {pearl_ate:.3f}")
print(f"Rubin IPW ATE: {ipw_ate:.3f}")
print(f"진정한 ATE: 0.500")
```

---

## 핵심 정리

- **잠재 결과 $Y(1), Y(0)$은 개인이 치료를 받거나 받지 않았을 때의 결과를 동시에 정의합니다**: 둘 중 하나만 관측 가능한 것이 인과 추론의 근본 문제입니다
- **SUTVA(간섭 없음 + 일관성)가 만족되어야 잠재 결과가 잘 정의됩니다**: 네트워크 효과가 있으면 SUTVA가 위반됩니다
- **ATE, ATT, CATE는 서로 다른 대상 집단에 대한 평균 인과 효과입니다**: 선택 편향이 있으면 세 값이 서로 다를 수 있습니다
- **무교란성, 양성성, 일관성의 세 가정 하에서 관측 데이터로 인과 효과를 식별할 수 있습니다**: 무교란성은 검증 불가능하므로 도메인 지식이 필수적입니다
- **Pearl과 Rubin의 프레임워크는 수학적으로 동치이며, 실무에서는 상호 보완적으로 활용됩니다**
