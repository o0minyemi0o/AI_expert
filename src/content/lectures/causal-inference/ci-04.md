# d-분리와 조건부 독립

## 왜 d-분리를 이해해야 하는가

ci-02에서 DAG의 세 가지 기본 구조(체인, 포크, 충돌자)를 배웠고, ci-03에서 백도어 기준을 활용한 인과 효과 식별을 다루었습니다. d-분리(d-separation)는 DAG에서 조건부 독립을 체계적으로 판단하는 그래프 기반 도구로, 어떤 변수를 통제해야 하고 어떤 변수를 통제하면 안 되는지를 명확히 알려줍니다.

---

## 1. d-분리의 정의

d-분리는 DAG에서 두 변수(또는 변수 집합) 사이의 모든 경로가 조건 집합 $\mathbf{Z}$에 의해 **차단(blocked)**되었는지를 판단하는 기준입니다.

$$
X \perp\!\!\!\perp_d Y \mid \mathbf{Z} \quad \text{in } \mathcal{G}
$$

이는 DAG $\mathcal{G}$에서 $X$와 $Y$ 사이의 모든 경로가 $\mathbf{Z}$에 의해 차단됨을 의미합니다.

| 용어 | 정의 |
|------|------|
| 경로 (Path) | 방향 무관하게 연결된 노드 시퀀스 |
| 차단 (Blocked) | 경로 상의 정보 흐름이 중단됨 |
| d-연결 (d-connected) | 최소 하나의 열린 경로 존재 |
| d-분리 (d-separated) | 모든 경로가 차단됨 |

> **핵심 직관**: d-분리는 "통계적 독립을 DAG만 보고 판단할 수 있는가?"라는 질문에 답합니다. 이를 통해 데이터를 보기 전에 어떤 조건부 독립이 성립하는지 예측할 수 있습니다.

---

## 2. 경로 차단과 활성화 규칙

경로가 차단되는지 여부는 경로 상의 각 노드와 조건 집합 $\mathbf{Z}$의 관계에 따라 결정됩니다.

$$
\text{체인}: \quad A \to B \to C \quad \Rightarrow \quad B \in \mathbf{Z} \text{이면 차단}
$$
$$
\text{포크}: \quad A \leftarrow B \to C \quad \Rightarrow \quad B \in \mathbf{Z} \text{이면 차단}
$$
$$
\text{충돌자}: \quad A \to B \leftarrow C \quad \Rightarrow \quad B \notin \mathbf{Z} \text{이면 차단}, B \in \mathbf{Z} \text{이면 활성화!}
$$

| 구조 | $B \notin \mathbf{Z}$ | $B \in \mathbf{Z}$ | 직관 |
|------|---------------------|-------------------|------|
| 체인 $A \to B \to C$ | 열림 | 차단 | B를 알면 A→C 정보 차단 |
| 포크 $A \leftarrow B \to C$ | 열림 | 차단 | 공통 원인을 통제하면 독립 |
| 충돌자 $A \to B \leftarrow C$ | 차단 | **열림** | 결과를 알면 원인 간 연결 |

> **핵심 직관**: 충돌자 편향(collider bias)은 ci-01의 Simpson's paradox와 밀접합니다. 입학 성적($B$)을 조건화하면 운동 능력($A$)과 학업 성적($C$)이 음의 상관을 보이는 현상이 대표적입니다.

```python
import numpy as np

# 충돌자 편향 시뮬레이션: 운동 능력, 학업 성적, 입학
np.random.seed(42)
n = 10000

athletic = np.random.normal(0, 1, n)   # 운동 능력
academic = np.random.normal(0, 1, n)   # 학업 성적 (운동과 독립!)
admission = athletic + academic         # 충돌자 (입학 점수)

# 무조건부: 운동과 학업은 독립
print(f"무조건부 상관: {np.corrcoef(athletic, academic)[0,1]:.3f}")  # ≈ 0

# 입학자 (admission > 1)만 관찰: 음의 상관 발생!
admitted = admission > 1
print(f"입학자 내 상관: {np.corrcoef(athletic[admitted], academic[admitted])[0,1]:.3f}")
```

---

## 3. d-분리 판정 알고리즘

임의의 DAG에서 $X$와 $Y$가 $\mathbf{Z}$에 대해 d-분리되는지를 체계적으로 판단하는 알고리즘입니다.

**알고리즘 (Bayes-Ball Algorithm):**

1. $X$와 $Y$ 사이의 모든 경로를 나열합니다
2. 각 경로에 대해 경로 상의 모든 노드를 검사합니다
3. 하나라도 열린 경로가 존재하면 d-연결, 모든 경로가 차단되면 d-분리입니다

$$
\text{경로 차단 조건}: \exists \text{ 노드 } W \text{ on path such that:}
$$
$$
\begin{cases}
W \in \mathbf{Z} & \text{if } W \text{는 체인 또는 포크의 중간 노드} \\
W \notin \mathbf{Z} \text{ and } \text{desc}(W) \cap \mathbf{Z} = \emptyset & \text{if } W \text{는 충돌자}
\end{cases}
$$

| 경로 예시 | 조건 집합 $\mathbf{Z}$ | 결과 |
|----------|---------------------|------|
| $X \to A \to Y$ | $\{A\}$ | 차단 |
| $X \leftarrow A \to Y$ | $\{A\}$ | 차단 |
| $X \to A \leftarrow Y$ | $\emptyset$ | 차단 |
| $X \to A \leftarrow Y$ | $\{A\}$ | 열림 |
| $X \to A \leftarrow Y$ | $\{B\}$ (B는 A의 자손) | 열림 |

> **핵심 직관**: 충돌자의 자손을 조건화해도 경로가 열립니다. "합격 여부"가 아니라 "합격한 학교의 랭킹"을 조건화해도 같은 편향이 발생합니다.

```python
import numpy as np

# d-분리 판정을 위한 간단한 구현 (개념적)
def is_d_separated(dag, X, Y, Z):
    """
    dag: dict of {node: [parents]}
    X, Y: 판정 대상 노드
    Z: 조건 집합
    반환: True면 d-분리
    """
    # 실무에서는 pgmpy, networkx 등 라이브러리 사용
    # from pgmpy.models import BayesianNetwork
    # model = BayesianNetwork(edges)
    # model.is_d_separated(X, Y, Z)
    pass

# 예시 DAG: A→B→C, A→D←C
dag = {
    'A': [],
    'B': ['A'],
    'C': ['B'],
    'D': ['A', 'C']
}
print("A와 C가 {B}에 의해 d-분리? → 예 (체인 차단)")
print("A와 C가 {D}에 의해 d-분리? → 아니오 (충돌자 활성화)")
```

---

## 4. 마르코프 조건과 충실성 가정

d-분리를 실제 확률 분포와 연결하려면 두 가지 핵심 가정이 필요합니다.

$$
\textbf{마르코프 조건}: \quad X \perp\!\!\!\perp_d Y \mid \mathbf{Z} \;\Rightarrow\; X \perp\!\!\!\perp Y \mid \mathbf{Z}
$$
$$
\textbf{충실성 가정}: \quad X \perp\!\!\!\perp Y \mid \mathbf{Z} \;\Rightarrow\; X \perp\!\!\!\perp_d Y \mid \mathbf{Z}
$$

| 가정 | 방향 | 의미 |
|------|------|------|
| 마르코프 조건 | 그래프 → 분포 | d-분리면 조건부 독립 |
| 충실성 (Faithfulness) | 분포 → 그래프 | 조건부 독립이면 d-분리 |
| 인과적 마르코프 | 인과 → 그래프 | 인과 구조가 DAG로 표현됨 |
| 인과적 충실성 | 추가 제약 없음 | 우연한 상쇄가 없음 |

> **핵심 직관**: 충실성 가정이 위반되는 경우는 두 경로의 효과가 정확히 상쇄되어 우연히 독립이 되는 상황입니다. 이는 측정값(measure-zero set)으로 현실에서 거의 발생하지 않습니다. ci-09의 인과 발견 알고리즘은 이 가정에 크게 의존합니다.

---

## 5. 좋은 통제 변수와 나쁜 통제 변수

ci-03의 백도어 기준과 d-분리를 결합하면, 인과 효과 추정 시 통제해야 할 변수와 통제하면 안 되는 변수를 명확히 구분할 수 있습니다.

| 변수 유형 | DAG 위치 | 통제 여부 | 이유 |
|----------|---------|----------|------|
| 교란 변수 | $X \leftarrow Z \to Y$ | 통제해야 함 | 백도어 경로 차단 |
| 매개 변수 | $X \to M \to Y$ | 통제 금지 | 인과 경로 차단됨 |
| 충돌자 | $X \to C \leftarrow Y$ | 통제 금지 | 편향 유발 |
| 도구 변수 | $Z \to X \to Y$ | ci-07 참고 | 특수 활용 |
| 무관 변수 | $X \to Y$, $W$ 독립 | 무해하나 불필요 | 정밀도 향상 가능 |

> **핵심 직관**: "모든 가용 변수를 통제한다"는 전략은 위험합니다. 매개 변수를 통제하면 인과 효과를 과소추정하고, 충돌자를 통제하면 존재하지 않는 편향을 만들어냅니다.

```python
import numpy as np

# 나쁜 통제 변수 예시: 매개 변수 통제
np.random.seed(42)
n = 10000

X = np.random.normal(0, 1, n)
M = 0.6 * X + np.random.normal(0, 0.5, n)  # 매개 변수
Y = 0.8 * M + np.random.normal(0, 0.5, n)  # 총 효과 = 0.6 * 0.8 = 0.48

# 올바른 추정: M 통제 안 함
import statsmodels.api as sm
correct = sm.OLS(Y, sm.add_constant(X)).fit()
print(f"올바른 총 인과 효과: {correct.params[1]:.3f}")  # ≈ 0.48

# 잘못된 추정: M 통제 (매개 변수 차단)
wrong = sm.OLS(Y, sm.add_constant(np.column_stack([X, M]))).fit()
print(f"M 통제 후 X 계수: {wrong.params[1]:.3f}")  # ≈ 0 (직접 효과만)
```

---

## 6. d-분리의 실무 활용

d-분리는 이론적 도구를 넘어 실무에서 여러 방면으로 활용됩니다.

| 활용 분야 | 설명 | 관련 강의 |
|----------|------|----------|
| 모형 검증 | DAG가 맞는지 조건부 독립 검정으로 확인 | ci-09 |
| 변수 선택 | 회귀에 포함할 통제 변수 결정 | ci-06 |
| 편향 분석 | 특정 통제 전략의 편향 방향 예측 | ci-05 |
| 식별 전략 | 인과 효과 식별 가능성 판단 | ci-03 |

> **핵심 직관**: d-분리를 이해하면 "왜 이 변수를 통제해야 하는가"와 "왜 이 변수를 통제하면 안 되는가"를 DAG만으로 명확히 설명할 수 있습니다. 이는 ci-06의 경향 점수 분석에서 공변량 선택에 직접 활용됩니다.

```python
# 실무 활용: pgmpy를 활용한 d-분리 검정 (개념적)
# pip install pgmpy

# from pgmpy.models import BayesianNetwork
# from pgmpy.inference import CausalInference

# model = BayesianNetwork([
#     ('Z', 'X'), ('Z', 'Y'), ('X', 'Y'),
#     ('X', 'M'), ('M', 'Y')
# ])

# 백도어 변수 자동 탐색
# ci = CausalInference(model)
# adjustment_set = ci.get_all_backdoor_adjustment_sets('X', 'Y')
# print(f"조정 집합: {adjustment_set}")

print("실무에서는 pgmpy, DoWhy 등의 라이브러리로")
print("d-분리 판정과 조정 집합 탐색을 자동화합니다")
```

---

## 핵심 정리

- **d-분리는 DAG에서 조건부 독립을 그래프만으로 판단하는 기준입니다**: 모든 경로가 차단되면 d-분리, 하나라도 열려 있으면 d-연결입니다
- **체인과 포크는 중간 노드를 조건화하면 차단되고, 충돌자는 조건화하면 오히려 열립니다**: 충돌자의 자손을 조건화해도 동일한 효과가 발생합니다
- **마르코프 조건과 충실성 가정은 그래프 구조와 확률 분포를 연결하는 핵심 가정입니다**: 인과 발견 알고리즘의 이론적 기반이 됩니다
- **매개 변수와 충돌자를 통제하면 편향이 발생하므로, 모든 변수를 무조건 통제하는 것은 위험합니다**
- **d-분리는 변수 선택, 모형 검증, 편향 분석 등 실무 전반에서 활용되는 핵심 도구입니다**
