# 시계열 분석과 예측

## 왜 시계열 모델 선택이 어려운가

시계열 예측은 주가, 전력 소비, 수요 예측 등 비즈니스에서 가장 직접적인 가치를 창출하는 ML 응용 중 하나입니다. 하지만 시계열은 독립동일분포(i.i.d.) 가정을 위반하고, 추세/계절성/외부 변수가 복합적으로 작용하며, 예측 구간에 따라 최적 모델이 완전히 달라집니다. 통계 모델, ML, 딥러닝 중 어느 것이 가장 적합한지는 데이터 특성과 예측 목표에 달려 있습니다.

---

## 1. 시계열 모델 스펙트럼

| 접근법 | 대표 모델 | 장점 | 단점 | 적합한 상황 |
|--------|----------|------|------|------------|
| 통계 | ARIMA, ETS | 이론적 기반, 불확실성 정량화 | 복잡한 패턴 한계 | 단변량, 짧은 계열 |
| 통계+자동화 | Prophet | 사용 쉬움, 이벤트 처리 | 정확도 한계 | 비즈니스 시계열 |
| ML | XGBoost + lag features | 외부 변수 통합 용이 | 시간 구조 무시 가능 | 다변량, 정형 피처 |
| DL | LSTM, TFT | 복잡한 패턴 학습 | 대량 데이터 필요 | 장기 의존성, 다변량 |
| 기초 | 이동 평균, 직전 값 | 극히 단순, 빠름 | 패턴 미반영 | 베이스라인 |

---

## 2. 통계 모델: ARIMA, ETS, Prophet

### ARIMA (AutoRegressive Integrated Moving Average)

자기회귀(AR) + 차분(I) + 이동평균(MA): $\text{ARIMA}(p, d, q)$

### 언제 쓰는가
- 단변량 시계열 (외부 변수 없음)
- 정상성(stationarity)으로 변환 가능한 데이터
- 짧은 예측 구간 (수 일~수 주)
- 불확실성 구간(신뢰구간)이 필요할 때

### ETS (Error, Trend, Seasonality)

지수 평활법의 일반화. 추세와 계절성을 명시적으로 모델링합니다.

### Prophet (Meta)

### 언제 쓰는가
- 비즈니스 시계열 (일별/주별 매출 등)
- 공휴일/이벤트 효과가 있을 때
- 비전문가도 사용 가능한 도구가 필요할 때
- 빠른 프로토타입

### 언제 쓰지 않는가
- 초단기(분/초) 예측
- 복잡한 다변량 의존성
- 최고 정확도가 필요할 때

```python
from statsmodels.tsa.holtwinters import ExponentialSmoothing
import numpy as np

# ETS 예시
np.random.seed(42)
# 추세 + 계절성이 있는 시계열 생성
t = np.arange(120)
y = 50 + 0.5 * t + 10 * np.sin(2 * np.pi * t / 12) + np.random.normal(0, 3, 120)

train, test = y[:96], y[96:]

model = ExponentialSmoothing(
    train, trend='add', seasonal='add', seasonal_periods=12
).fit()

forecast = model.forecast(len(test))
mae = np.mean(np.abs(test - forecast))
print(f"ETS MAE: {mae:.2f}")
```

> **핵심 직관**: 통계 모델의 가장 큰 장점은 **불확실성 정량화**입니다. "내일 매출은 100만원"보다 "내일 매출은 80~120만원 (95% 신뢰구간)"이 비즈니스 의사결정에 훨씬 유용합니다.

---

## 3. ML 접근: XGBoost + Lag Features

시계열을 정형 데이터로 변환하여 트리 모델을 적용하는 전략입니다.

### 핵심: 피처 엔지니어링

| 피처 유형 | 예시 | 효과 |
|----------|------|------|
| Lag 피처 | $y_{t-1}, y_{t-7}, y_{t-30}$ | 자기 상관 포착 |
| 롤링 통계 | 이동 평균, 이동 표준편차 | 추세/변동성 |
| 달력 피처 | 요일, 월, 공휴일 여부 | 계절성 |
| 외부 변수 | 날씨, 프로모션, 경쟁사 | 인과적 영향 |

### 언제 쓰는가
- 외부 변수(exogenous features)가 많을 때
- 정형 데이터 피처 엔지니어링에 익숙할 때
- 여러 시계열을 함께 학습할 때 (global model)

### 언제 쓰지 않는가
- 시간적 의존성이 매우 길 때 (lag 수 폭발)
- 불확실성 구간이 필요할 때 (기본적으로 제공 안 됨)

```python
import pandas as pd
import numpy as np
from sklearn.model_selection import TimeSeriesSplit
import lightgbm as lgb

# 시계열 → 정형 데이터 변환
def create_features(series, lags=[1, 7, 14, 30]):
    df = pd.DataFrame({'y': series})
    for lag in lags:
        df[f'lag_{lag}'] = df['y'].shift(lag)
    df['rolling_mean_7'] = df['y'].shift(1).rolling(7).mean()
    df['rolling_std_7'] = df['y'].shift(1).rolling(7).std()
    df['dayofweek'] = df.index.dayofweek if hasattr(df.index, 'dayofweek') else 0
    return df.dropna()

np.random.seed(42)
series = pd.Series(np.random.randn(365).cumsum() + 100)
df = create_features(series)

X = df.drop('y', axis=1)
y = df['y']

# TimeSeriesSplit으로 시간 순서 유지
tscv = TimeSeriesSplit(n_splits=3)
for fold, (train_idx, val_idx) in enumerate(tscv.split(X)):
    model = lgb.LGBMRegressor(n_estimators=100, verbose=-1)
    model.fit(X.iloc[train_idx], y.iloc[train_idx])
    pred = model.predict(X.iloc[val_idx])
    mae = np.mean(np.abs(y.iloc[val_idx] - pred))
    print(f"Fold {fold+1} MAE: {mae:.2f}")
```

> **핵심 직관**: 시계열에서 일반적인 K-Fold 교차 검증을 사용하면 **미래 데이터로 과거를 예측하는** 데이터 누출이 발생합니다. 반드시 `TimeSeriesSplit` 등 시간 순서를 보존하는 분할을 사용하십시오.

### 시나리오: 편의점 일별 매출 예측

편의점 프랜차이즈에서 1,000개 점포의 일별 매출을 예측하려 합니다. 데이터는 365일 × 1,000개 점포(36.5만 행), 피처는 요일, 날씨(기온/강수량), 프로모션 여부, 주변 이벤트 등 15개입니다. 목표는 3일 후 점포별 매출 예측입니다.

단일 점포마다 ARIMA를 적용하면 1,000개 모델을 관리해야 하고, 점포당 365일이라는 짧은 시계열로 계절성 포착이 어렵습니다. 대신 전체 점포 데이터를 통합하여 XGBoost를 학습하면, lag features(1일 전/7일 전/30일 전 매출)와 외부 변수(날씨, 프로모션)를 자연스럽게 통합할 수 있습니다. 통합 모델은 유사한 상권의 점포 간 패턴을 공유하여 개별 ARIMA 대비 MAE가 15~20% 낮아지는 경우가 많습니다. 모델 1개로 전체 점포를 관리할 수 있어 운영 효율도 훨씬 높습니다.

---

## 4. 딥러닝: LSTM, Temporal Fusion Transformer

### LSTM

### 언제 쓰는가
- 장기 시간 의존성이 중요할 때 (dl-06 참조)
- 다변량 시계열
- 데이터가 충분할 때 (수만 시점 이상)

### Temporal Fusion Transformer (TFT)

### 언제 쓰는가
- 다양한 시간 해상도의 피처가 있을 때
- 해석가능한 딥러닝 예측이 필요할 때 (어텐션 가중치)
- 여러 시계열을 동시에 모델링할 때

| 모델 | 다변량 | 장기 의존성 | 해석성 | 불확실성 | 데이터 요구 |
|------|--------|-----------|--------|---------|-----------|
| ARIMA | 제한적 (VARIMA) | 약함 | 높음 | 제공 | 낮음 |
| Prophet | 지원 | 중간 | 중간 | 제공 | 낮음 |
| XGBoost+lag | 지원 | 피처 의존 | 중간 | 미제공 | 중간 |
| LSTM | 지원 | 강함 | 낮음 | 미제공 | 높음 |
| TFT | 지원 | 강함 | 중간 | 제공 | 높음 |

---

## 5. 예측 구간에 따른 선택

```
예측 구간에 따른 모델 선택:

예측 구간은?
├── 초단기 (분~시간)
│   ├── 높은 빈도 → ARIMA / 이동 평균
│   └── 복잡한 패턴 → LSTM
├── 단기 (1일~1주)
│   ├── 단변량 → ARIMA / ETS / Prophet
│   └── 다변량 → XGBoost + lag + 외부변수
├── 중기 (1주~1개월)
│   ├── 계절성 강함 → SARIMA / Prophet
│   └── 외부 영향 큼 → XGBoost / TFT
└── 장기 (1개월~1년)
    ├── 추세만 중요 → ETS / 선형 추세
    └── 복합 패턴 → TFT / 앙상블
        └── 주의: 장기 예측의 불확실성은 매우 큼
```

| 예측 구간 | 추천 1순위 | 추천 2순위 | 주의점 |
|----------|-----------|-----------|--------|
| 분~시간 | 이동 평균 / ARIMA | LSTM | 노이즈 민감 |
| 1일~1주 | Prophet / ARIMA | XGBoost + lag | 외부 변수 확인 |
| 1주~1개월 | XGBoost + 외부변수 | TFT | 계절성 모델링 중요 |
| 1개월~1년 | 추세 모델 | 앙상블 | 불확실성 매우 큼 |

> **핵심 직관**: 예측 구간이 길어질수록 **모델의 정확도보다 불확실성 추정이 더 중요**해집니다. 6개월 후 매출을 정확히 예측하는 것은 불가능하지만, 합리적인 범위를 제시하는 것은 가능합니다.

### 시나리오: 전력 수요 예측

전력 거래소에서 전력 수요를 예측하여 발전 계획을 수립합니다. 데이터는 15분 간격으로 3년간 수집된 약 10만 5,000개 시점의 전력 소비량이며, 피처는 기온, 습도, 요일, 공휴일 여부, 산업용/가정용 비율 등 20개입니다.

단기 예측(1시간 후, 4개 시점)에서는 LSTM이 강점을 보입니다. 15분 단위의 빠른 변동 패턴과 비선형 온도-전력 관계를 포착하는 데 유리하며, 충분한 데이터(10만 포인트)가 딥러닝 학습을 뒷받침합니다. 반면 장기 예측(1주 후, 672개 시점)에서는 Prophet이나 SARIMA가 더 안정적입니다. LSTM은 장기 예측에서 오차가 누적되어 발산하는 경향이 있지만, Prophet은 주간/연간 계절성과 공휴일 효과를 명시적으로 모델링하여 안정적인 예측 구간을 제공합니다. 실무에서는 단기 LSTM + 장기 Prophet의 앙상블이 가장 효과적입니다.

---

## 핵심 정리

1. **통계 모델(ARIMA, ETS)은 단변량 + 단기 예측의 최적 도구**: 이론적 근거가 튼튼하고 불확실성 구간을 자연스럽게 제공하며, 소량 데이터에서도 안정적입니다.
2. **XGBoost + lag features는 다변량 시계열의 실전 강자**: 외부 변수를 자연스럽게 통합할 수 있고, 정형 데이터 파이프라인을 재활용할 수 있어 실무에서 가장 많이 사용됩니다.
3. **딥러닝(LSTM, TFT)은 대규모 + 복잡한 의존성에서 유리**: 충분한 데이터가 있고 장기 시간 의존성이 중요한 과제에서 통계/ML 모델을 능가합니다.
4. **시계열에서는 반드시 시간 순서를 보존하는 검증 사용**: 일반 K-Fold는 데이터 누출을 유발하므로, TimeSeriesSplit이나 walk-forward 검증을 사용해야 합니다.
5. **예측 구간이 길어지면 불확실성 추정에 집중**: 장기 예측에서는 점 추정(point forecast)보다 예측 구간(prediction interval)이 비즈니스 의사결정에 더 유용합니다.
